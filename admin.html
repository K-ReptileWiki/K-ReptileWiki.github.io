<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; }
    header { 
      background:#2563eb; 
      color:white; 
      padding:15px; 
      text-align:center;
      position:relative;
    }
    .exit-btn {
      position:absolute;
      right:20px;
      top:15px;
      background:#f87171;
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }
    nav { 
      display:flex; 
      background:#e5e7eb; 
      overflow-x:auto;
    }
    nav button {
      flex:1; 
      padding:12px; 
      border:none; 
      background:#e5e7eb;
      cursor:pointer; 
      font-size:16px; 
      transition:background 0.2s;
      white-space:nowrap;
    }
    nav button:hover { background:#d1d5db; }
    nav button.active { background:white; border-bottom:3px solid #2563eb; }
    section { 
      padding:20px; 
      display:none;
      max-width:1200px;
      margin:0 auto;
    }
    section.active { display:block; }
    .card-list { 
      display:grid;
      gap:15px;
      grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
    }
    .card {
      background:white;
      padding:15px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .card h3 {
      margin-top:0;
      color:#2563eb;
    }
    button.action-btn {
      margin:3px;
      padding:6px 12px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-size:14px;
    }
    .btn-danger { background:#f87171; color:white; }
    .btn-success { background:#10b981; color:white; }
    .btn-warning { background:#fbbf24; color:white; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ›  K-ReptileWiki ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <button id="exitAdmin" class="exit-btn">ê´€ë¦¬ì í˜ì´ì§€ ë‚˜ê°€ê¸°</button>
  </header>

  <nav>
    <button id="tabUsers" class="active">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
    <button id="tabPosts">ğŸ“ ê¸€ ê´€ë¦¬</button>
    <button id="tabComments">ğŸ’¬ ëŒ“ê¸€ ê´€ë¦¬</button>
  </nav>

  <section id="users" class="active">
    <h2>ì‚¬ìš©ì ëª©ë¡</h2>
    <div id="userList" class="card-list">ë¡œë”© ì¤‘...</div>
  </section>

  <section id="posts">
    <h2>ê¸€ ëª©ë¡</h2>
    <div id="postList" class="card-list">ë¡œë”© ì¤‘...</div>
  </section>

  <section id="comments">
    <h2>ëŒ“ê¸€ ëª©ë¡</h2>
    <div id="commentList" class="card-list">ë¡œë”© ì¤‘...</div>
  </section>

  <script type="module">
    import { supabaseService, supabase } from "./js/supabase.js";

    // ê¶Œí•œ í™•ì¸
    if (!supabaseService.isLoggedIn() || !supabaseService.isAdmin()) {
      alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤");
      location.href = "index.html";
    }

    // íƒ­ ì „í™˜
    const tabs = {
      tabUsers: "users",
      tabPosts: "posts",
      tabComments: "comments"
    };

    Object.entries(tabs).forEach(([btnId, secId]) => {
      document.getElementById(btnId).addEventListener("click", () => {
        Object.keys(tabs).forEach(id => 
          document.getElementById(id).classList.remove("active")
        );
        document.getElementById(btnId).classList.add("active");

        Object.values(tabs).forEach(id => 
          document.getElementById(id).classList.remove("active")
        );
        document.getElementById(secId).classList.add("active");
      });
    });

    // ë‚˜ê°€ê¸°
    document.getElementById("exitAdmin").addEventListener("click", () => {
      location.href = "index.html";
    });

    // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
    async function loadUsers() {
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .order("created_at", { ascending: false });

      const div = document.getElementById("userList");
      
      if (error) {
        div.innerHTML = `<p>ì˜¤ë¥˜: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        div.innerHTML = "<p>ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>";
        return;
      }

      div.innerHTML = "";
      data.forEach(user => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${user.nickname ?? "ë‹‰ë„¤ì„ì—†ìŒ"}</h3>
          <p><strong>ì´ë©”ì¼:</strong> ${user.email}</p>
          <p><strong>ê¶Œí•œ:</strong> ${user.role ?? "user"}</p>
          <p><strong>ê°€ì…ì¼:</strong> ${new Date(user.created_at).toLocaleString()}</p>
          ${user.role !== "admin" ? 
            `<button class="action-btn btn-success" onclick="makeAdmin('${user.id}')">ê´€ë¦¬ì ìŠ¹ê²©</button>` :
            `<button class="action-btn btn-warning" onclick="removeAdmin('${user.id}')">ê´€ë¦¬ì í•´ì œ</button>`
          }
        `;
        div.appendChild(card);
      });
    }

    // ê¸€ ëª©ë¡ ë¡œë“œ
    async function loadPosts() {
      const result = await supabaseService.getPosts(100);
      const div = document.getElementById("postList");

      if (!result.success) {
        div.innerHTML = `<p>ì˜¤ë¥˜: ${result.error}</p>`;
        return;
      }

      if (!result.data || result.data.length === 0) {
        div.innerHTML = "<p>ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>";
        return;
      }

      div.innerHTML = "";
      result.data.forEach(post => {
        const card = document.createElement("div");
        card.className = "card";
        const plainText = post.content?.replace(/<[^>]+>/g, "").substring(0, 100) ?? "";
        card.innerHTML = `
          <h3>${post.title}</h3>
          <p>${plainText}...</p>
          <p><strong>ì‘ì„±ì:</strong> ${post.author ?? "ìµëª…"}</p>
          <p><strong>ì‘ì„±ì¼:</strong> ${new Date(post.time).toLocaleString()}</p>
          <button class="action-btn btn-danger" onclick="deletePost('${post.id}')">ì‚­ì œ</button>
          <button class="action-btn btn-success" onclick="viewPost('${post.id}')">ë³´ê¸°</button>
        `;
        div.appendChild(card);
      });
    }

    // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
    async function loadComments() {
      const { data, error } = await supabase
        .from("wiki_comments")
        .select("*")
        .order("time", { ascending: false })
        .limit(100);

      const div = document.getElementById("commentList");

      if (error) {
        div.innerHTML = `<p>ì˜¤ë¥˜: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        div.innerHTML = "<p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>";
        return;
      }

      div.innerHTML = "";
      data.forEach(comment => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <p><strong>${comment.author ?? "ìµëª…"}</strong></p>
          <p>${comment.content}</p>
          <p><small>${new Date(comment.time).toLocaleString()}</small></p>
          <button class="action-btn btn-danger" onclick="deleteComment('${comment.id}')">ì‚­ì œ</button>
        `;
        div.appendChild(card);
      });
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥
    window.makeAdmin = async (uid) => {
      if (!confirm("ì´ ì‚¬ìš©ìë¥¼ ê´€ë¦¬ìë¡œ ìŠ¹ê²©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase
        .from("profiles")
        .update({ role: "admin" })
        .eq("id", uid);
      if (error) alert("ì‹¤íŒ¨: " + error.message);
      else {
        alert("ê´€ë¦¬ìë¡œ ìŠ¹ê²©ë˜ì—ˆìŠµë‹ˆë‹¤");
        loadUsers();
      }
    };

    window.removeAdmin = async (uid) => {
      if (!confirm("ì´ ì‚¬ìš©ìì˜ ê´€ë¦¬ì ê¶Œí•œì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase
        .from("profiles")
        .update({ role: "user" })
        .eq("id", uid);
      if (error) alert("ì‹¤íŒ¨: " + error.message);
      else {
        alert("ê´€ë¦¬ì ê¶Œí•œì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤");
        loadUsers();
      }
    };

    window.deletePost = async (postId) => {
      if (!confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase
        .from("wiki_posts")
        .delete()
        .eq("id", postId);
      if (error) alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
      else {
        alert("ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
        loadPosts();
      }
    };

    window.viewPost = (postId) => {
      window.open(`post.html?id=${postId}`, "_blank");
    };

    window.deleteComment = async (commentId) => {
      if (!confirm("ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase
        .from("wiki_comments")
        .delete()
        .eq("id", commentId);
      if (error) alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
      else {
        alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
        loadComments();
      }
    };

    // ì´ˆê¸° ë¡œë“œ
    loadUsers();
    loadPosts();
    loadComments();
  </script>
</body>
</html>
