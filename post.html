<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:20px; }
    h1 { color:#2563eb; }
    .post-detail { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .comment-card { background:#fff; padding:15px; margin-bottom:10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
    button { margin:5px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
    .delete-btn { background:#f87171; color:white; }
  </style>
</head>
<body>
  <h1>ğŸ¦ K-ReptileWiki ê¸€ ìƒì„¸</h1>
  <div id="postDetail" class="post-detail"></div>

  <hr>
  <h2>ğŸ’¬ ëŒ“ê¸€</h2>
  <ul id="commentList"></ul>

  <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;height:80px;"></textarea><br>
  <button id="addCommentBtn">ëŒ“ê¸€ ì‘ì„±</button>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://cpaikpjzlzzujwfgnanb.supabase.co";
    const supabaseKey = "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    // ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸
    const { data: userRes } = await supabase.auth.getUser();
    currentUser = userRes?.user ?? null;

    const params = new URLSearchParams(location.search);
    const postId = params.get("id");

    if (!postId) {
      document.getElementById("postDetail").textContent = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ê¸€ IDê°€ ì—†ìŠµë‹ˆë‹¤.";
    } else {
      loadPost();
      loadComments();
    }

    // ê´€ë¦¬ì íŒë³„
    function hasAdminRole(user) {
      return user?.user_metadata?.role === "admin" || user?.app_metadata?.role === "admin";
    }

    // ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPost() {
      const { data, error } = await supabase
        .from("wiki_posts").select("*").eq("id", postId).single();

      const div = document.getElementById("postDetail");
      if (error || !data) {
        div.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      let imgHtml = "";
      if (data.images && Array.isArray(data.images)) {
        imgHtml = data.images.map(url => `<img src="${url}" style="max-width:200px;margin:5px;">`).join("");
      }

      div.innerHTML = `
        <h2>${data.title}</h2>
        <div>${data.content}</div>
        ${imgHtml}
        <small>ì‘ì„±ì: ${data.author ?? "ìµëª…"} | ${new Date(data.time).toLocaleString()}</small><br>
      `;

      // ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìë©´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      if (currentUser && (currentUser.id === data.uid || hasAdminRole(currentUser))) {
        const btn = document.createElement("button");
        btn.className = "delete-btn";
        btn.textContent = "ê¸€ ì‚­ì œ";
        btn.onclick = () => deletePost(data.id);
        div.appendChild(btn);
      }
    }

    // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadComments() {
      const { data, error } = await supabase
        .from("wiki_comments")
        .select("*")
        .eq("post_id", postId)
        .order("time", { ascending: false });

      const ul = document.getElementById("commentList");
      ul.innerHTML = "";

      if (error) {
        ul.textContent = "ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
        return;
      }
      if (!data || data.length === 0) {
        ul.textContent = "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      data.forEach(c => {
        const li = document.createElement("li");
        li.className = "comment-card";
        li.innerHTML = `
          <p>${c.content}</p>
          <small>${c.author ?? "ìµëª…"} | ${new Date(c.time).toLocaleString()}</small><br>
        `;

        if (currentUser && (currentUser.id === c.uid || hasAdminRole(currentUser))) {
          const btn = document.createElement("button");
          btn.className = "delete-btn";
          btn.textContent = "ëŒ“ê¸€ ì‚­ì œ";
          btn.onclick = () => deleteComment(c.id);
          li.appendChild(btn);
        }

        ul.appendChild(li);
      });
    }

    // ëŒ“ê¸€ ì‘ì„±
    document.getElementById("addCommentBtn").onclick = async () => {
      const content = document.getElementById("commentInput").value.trim();
      if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
      if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");

      const { error } = await supabase.from("wiki_comments").insert([{
        post_id: postId,
        content,
        author: currentUser.email ?? "ìµëª…",
        uid: currentUser.id,
        time: new Date().toISOString()
      }]);

      if (error) {
        alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: " + error.message);
      } else {
        document.getElementById("commentInput").value = "";
        loadComments();
      }
    };

    // ê¸€ ì‚­ì œ
    async function deletePost(id) {
      if (!confirm("ì •ë§ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase.from("wiki_posts").delete().eq("id", id);
      if (error) return alert("ê¸€ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
      alert("ê¸€ ì‚­ì œ ì™„ë£Œ");
      location.href = "index.html";
    }

    // ëŒ“ê¸€ ì‚­ì œ
    async function deleteComment(id) {
      if (!confirm("ì •ë§ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase.from("wiki_comments").delete().eq("id", id);
      if (error) return alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
      alert("ëŒ“ê¸€ ì‚­ì œ ì™„ë£Œ");
      loadComments();
    }
  </script>
</body>
</html>
