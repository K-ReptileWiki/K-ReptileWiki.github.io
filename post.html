<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background:#f9fafb; }
    .container { max-width:900px; margin:20px auto; padding:20px; }
    .post-detail { background:white; padding:30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    .post-detail h2 { color:#2563eb; margin-top:0; }
    .post-detail img { max-width:100%; height:auto; border-radius:8px; margin:10px 0; }
    .post-meta { color:#6b7280; font-size:14px; margin:15px 0; padding:10px; background:#f3f4f6; border-radius:4px; }
    .post-stats { display:flex; gap:15px; align-items:center; margin:15px 0; }
    .stat-item { display:flex; align-items:center; gap:5px; padding:8px 12px; background:#f3f4f6; border-radius:6px; font-size:14px; color:#475569; }
    .stat-item .icon { font-size:16px; }
    .btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-right:10px; }
    .btn-primary { background:#2563eb; color:white; }
    .btn-danger { background:#f87171; color:white; }
    .btn-secondary { background:#6b7280; color:white; }
    .btn-warning { background:#fbbf24; color:white; }
    .comment-section, .version-section { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    .comment-card, .version-card { background:#f9fafb; padding:15px; margin:10px 0; border-radius:6px; border-left:3px solid #2563eb; }
    .version-card { border-left-color:#fbbf24; cursor:pointer; transition:all 0.2s; }
    .version-card:hover { background:#f3f4f6; transform:translateX(5px); }
    .version-card.current { border-left-color:#10b981; background:#ecfdf5; }
    .comment-input { width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; resize:vertical; min-height:80px; box-sizing:border-box; }
    .version-badge { display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:bold; margin-right:5px; }
    .badge-created { background:#dbeafe; color:#1e40af; }
    .badge-updated { background:#fef3c7; color:#92400e; }
    .badge-deleted { background:#fee2e2; color:#991b1b; }
    .badge-current { background:#d1fae5; color:#065f46; }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ¦ K-ReptileWiki</h1>

  <div id="postDetail" class="post-detail">ë¡œë”© ì¤‘...</div>
  <button id="goHomeBtn" class="btn btn-secondary">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <hr style="margin:30px 0;">

  <div class="version-section">
    <h2>ğŸ“œ ë²„ì „ íˆìŠ¤í† ë¦¬</h2>
    <p style="color:#666;font-size:14px;">ì´ ê¸€ì˜ ëª¨ë“  ìˆ˜ì • ì´ë ¥ì„ í™•ì¸í•˜ê³  ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <div id="versionList">ë¡œë”© ì¤‘...</div>
  </div>

  <hr style="margin:30px 0;">

  <div class="comment-section">
    <h2>ğŸ’¬ ëŒ“ê¸€</h2>
    <div id="commentList">ë¡œë”© ì¤‘...</div>
    <h3 style="margin-top:30px;">ëŒ“ê¸€ ì‘ì„±</h3>
    <textarea id="commentInput" class="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button id="addCommentBtn" class="btn btn-primary" style="margin-top:10px;">ëŒ“ê¸€ ì‘ì„±</button>
  </div>
</div>

<script type="module">
import { supabaseService } from "./js/supabase.js";

const params = new URLSearchParams(location.search);
const postId = params.get("id");
let currentVersion = null;

if (!postId) location.href = "index.html";

async function init() {
  await supabaseService.waitForAuth();
  
  // âœ… ì¡°íšŒìˆ˜ ê¸°ë¡ (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™)
  await recordView();
  
  await loadPost();
  await loadVersions();
  await loadComments();
}

// âœ… ì¡°íšŒìˆ˜ ê¸°ë¡ í•¨ìˆ˜
async function recordView() {
  const result = await supabaseService.recordView(postId);
  if (result.success && !result.alreadyViewed) {
    console.log("ğŸ‘€ ì¡°íšŒìˆ˜ ì¦ê°€");
  }
}

async function loadPost() {
  const div = document.getElementById("postDetail");
  const result = await supabaseService.getPost(postId);

  if (!result.success) {
    div.innerHTML = `<p>ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${result.error}</p>`;
    return;
  }

  const post = result.data;
  currentVersion = post.version;

  // âœ… ì¡°íšŒìˆ˜ ê°€ì ¸ì˜¤ê¸°
  const viewCount = await supabaseService.getViewCount(postId);
  const likeCount = await supabaseService.getLikeCount(postId);

  const deletedBanner = post.deleted ? `<div style="background:#fee2e2;color:#991b1b;padding:10px;border-radius:4px;margin-bottom:15px;">
    âš ï¸ ì´ ê¸€ì€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ${post.deleted_at ? new Date(post.deleted_at).toLocaleString() : ''}</div>` : '';

  let imgHtml = "";
  if (post.images && Array.isArray(post.images)) imgHtml = post.images.map(u=>`<img src="${u}" class="species-image" alt="ì²¨ë¶€ ì´ë¯¸ì§€">`).join("");

  div.innerHTML = `
    ${deletedBanner}
    <h2>${post.title}</h2>
    <div class="post-meta">
      ë²„ì „: ${post.version} | ì‘ì„±ì: ${post.author??"ìµëª…"} | ${new Date(post.time).toLocaleString()}
    </div>
    
    <!-- âœ… ì¡°íšŒìˆ˜ & ì¢‹ì•„ìš” í†µê³„ -->
    <div class="post-stats">
      <div class="stat-item">
        <span class="icon">ğŸ‘€</span>
        <span>ì¡°íšŒ <strong id="viewCount">${viewCount}</strong></span>
      </div>
      <div class="stat-item">
        <span class="icon">â¤ï¸</span>
        <span>ì¢‹ì•„ìš” <strong id="likeCountDisplay">${likeCount}</strong></span>
      </div>
    </div>
    
    <div>${post.content}</div>
    ${imgHtml}
    <div style="margin-top:20px;">
      <button id="likeBtn" class="btn btn-primary">â¤ï¸ ë¡œë”© ì¤‘...</button>
      <span id="likeMsg" style="color:#10b981;margin-left:10px;"></span>
      <span id="actionBtnContainer"></span>
    </div>
  `;

  await updateLikeButton();
  renderActionButtons(post);
}

function renderActionButtons(post) {
  const container = document.getElementById("actionBtnContainer");
  container.innerHTML = "";

  if (!supabaseService.isLoggedIn()) return;
  const { user } = supabaseService.getCurrentUser();
  const isAuthor = user?.id === post.uid;
  const isAdmin = supabaseService.isAdmin();

  if (!post.deleted && (isAuthor || isAdmin)) {
    if (isAuthor) {
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-warning";
      editBtn.textContent = "âœï¸ ìˆ˜ì •";
      editBtn.onclick = () => editPost(post);
      container.appendChild(editBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn btn-danger";
      deleteBtn.textContent = "ğŸ—‘ï¸ ì‚­ì œ";
      deleteBtn.onclick = () => deletePost(post);
      container.appendChild(deleteBtn);
    }

    if (isAdmin && post.deleted) {
      const restoreBtn = document.createElement("button");
      restoreBtn.className = "btn btn-warning";
      restoreBtn.textContent = "â™»ï¸ ìµœì‹  ë²„ì „ìœ¼ë¡œ ë³µì›";
      restoreBtn.onclick = () => restoreLatestVersion();
      container.appendChild(restoreBtn);
    }
  }
}

async function updateLikeButton() {
  const likeBtn = document.getElementById("likeBtn");
  const count = await supabaseService.getLikeCount(postId);
  
  // âœ… ì¢‹ì•„ìš” ìˆ˜ë„ ì—…ë°ì´íŠ¸
  const likeCountDisplay = document.getElementById("likeCountDisplay");
  if (likeCountDisplay) likeCountDisplay.textContent = count;
  
  likeBtn.textContent = `â¤ï¸ ${count}`;

  likeBtn.onclick = async () => {
    if (!supabaseService.isLoggedIn()) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤"); location.href="login.html"; return; }
    const res = await supabaseService.toggleLike(postId);
    if (res.success) {
      document.getElementById("likeMsg").textContent = "ì¢‹ì•„ìš”!";
      setTimeout(()=>document.getElementById("likeMsg").textContent="",2000);
      await updateLikeButton();
    } else alert(res.error);
  };
}

async function loadVersions() {
  const div = document.getElementById("versionList");
  const result = await supabaseService.getPostVersions(postId);
  if (!result.success) { div.innerHTML=`<p>ë²„ì „ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${result.error}</p>`; return; }
  if (!result.data || result.data.length===0) { div.innerHTML="<p>ë²„ì „ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

  div.innerHTML = "";
  result.data.forEach(v=>{
    const versionDiv = document.createElement("div");
    versionDiv.className = `version-card ${v.version_number===currentVersion?'current':''}`;
    versionDiv.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>ë²„ì „ ${v.version_number}</strong>
          <span class="version-badge ${v.action==='created'?'badge-created':v.action==='updated'?'badge-updated':'badge-deleted'}">${v.action}</span>
          ${v.version_number===currentVersion?'<span class="version-badge badge-current">í˜„ì¬</span>':''}<br>
          <small style="color:#666;">${new Date(v.created_at).toLocaleString()} | ${v.author??"ìµëª…"}</small>
          ${v.change_note?`<br><small style="color:#999;">${v.change_note}</small>`:""}
        </div>
        <div>
          <button class="btn btn-secondary viewVersionBtn" data-version="${v.version_number}" style="padding:4px 8px;font-size:12px;">ğŸ‘ï¸ ë³´ê¸°</button>
          ${(v.version_number!==currentVersion && (supabaseService.isAdmin() || supabaseService.getCurrentUser().user?.id===v.uid))?`<button class="btn btn-warning restoreVersionBtn" data-version="${v.version_number}" style="padding:4px 8px;font-size:12px;">â™»ï¸ ë³µì›</button>`:""}
        </div>
      </div>
    `;
    div.appendChild(versionDiv);
  });

  div.querySelectorAll(".viewVersionBtn").forEach(btn=>{
    btn.addEventListener("click",()=>viewVersion(parseInt(btn.dataset.version)));
  });
  div.querySelectorAll(".restoreVersionBtn").forEach(btn=>{
    btn.addEventListener("click",()=>restoreVersion(parseInt(btn.dataset.version)));
  });
}

async function viewVersion(versionNumber) {
  const res = await supabaseService.getPostVersion(postId,versionNumber);
  if (!res.success){ alert("ë²„ì „ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: "+res.error); return; }
  const v = res.data;
  const modal = document.createElement("div");
  modal.style.cssText=`position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;`;
  let imgHtml="";
  if (v.images && Array.isArray(v.images)) imgHtml=v.images.map(u=>`<img src="${u}" style="max-width:100%;border-radius:8px;margin:10px 0;">`).join("");
  modal.innerHTML=`
    <div style="background:white;padding:30px;border-radius:8px;max-width:800px;max-height:80vh;overflow-y:auto;">
      <h2 style="color:#2563eb;margin-top:0;">ë²„ì „ ${v.version_number}</h2>
      <div style="color:#666;font-size:14px;margin-bottom:15px;">
        ${new Date(v.created_at).toLocaleString()} | ${v.author??"ìµëª…"}
      </div>
      <hr>
      <h3>${v.title}</h3>
      <div>${v.content}</div>
      ${imgHtml}
      <div style="margin-top:20px;text-align:right;">
        <button class="btn btn-secondary closeBtn">ë‹«ê¸°</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector(".closeBtn").onclick=()=>modal.remove();
  modal.addEventListener("click",e=>{if(e.target===modal)modal.remove();});
}

async function restoreVersion(versionNumber) {
  if (!confirm(`ë²„ì „ ${versionNumber}ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  const res = await supabaseService.restorePostVersion(postId,versionNumber);
  if(res.success){ alert("ë³µì› ì™„ë£Œ"); location.reload(); } else alert("ë³µì› ì‹¤íŒ¨: "+res.error);
}

async function restoreLatestVersion() {
  const res = await supabaseService.getPostVersions(postId);
  if(!res.success || !res.data || res.data.length===0){ alert("ë³µì›í•  ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
  await restoreVersion(res.data[0].version_number);
}

function editPost(post){
  const newTitle = prompt("ì œëª©:",post.title);
  if(!newTitle) return;
  const newContent = prompt("ë‚´ìš© (HTML):",post.content);
  if(!newContent) return;
  updatePost(newTitle,newContent,post.images);
}

async function updatePost(title,content,images){
  const res = await supabaseService.updatePost(postId,title,content,images);
  if(res.success){ alert("ìˆ˜ì • ì™„ë£Œ"); location.reload(); } else alert("ìˆ˜ì • ì‹¤íŒ¨: "+res.error);
}

async function deletePost(){
  if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const res = await supabaseService.deletePost(postId);
  if(res.success){ alert("ì‚­ì œ ì™„ë£Œ"); location.reload(); } else alert("ì‚­ì œ ì‹¤íŒ¨: "+res.error);
}

async function loadComments(){
  const res = await supabaseService.getComments(postId);
  const list = document.getElementById("commentList");
  if(!res.success){ list.textContent="ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"; return; }
  if(!res.data || res.data.length===0){ list.innerHTML="<p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
  list.innerHTML="";
  res.data.forEach(c=>{
    const div=document.createElement("div");
    div.className="comment-card";
    div.innerHTML=`<p>${c.content}</p><small>${c.author??"ìµëª…"} | ${new Date(c.time).toLocaleString()}</small>`;
    list.appendChild(div);
  });
}

document.getElementById("addCommentBtn").addEventListener("click",async ()=>{
  const content=document.getElementById("commentInput").value.trim();
  if(!content){ alert("ëŒ“ê¸€ ì…ë ¥"); return; }
  if(!supabaseService.isLoggedIn()){ alert("ë¡œê·¸ì¸ í•„ìš”"); location.href="login.html"; return; }
  const res = await supabaseService.addComment(postId,content);
  if(res.success){ document.getElementById("commentInput").value=""; await loadComments(); }
  else alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: "+res.error);
});

document.getElementById("goHomeBtn").addEventListener("click",()=>location.href="index.html");

init();
</script>
</body>
</html>
