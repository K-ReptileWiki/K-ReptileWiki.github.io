<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <h1>ğŸ¦ K-ReptileWiki ê¸€ ìƒì„¸</h1>
  <div id="postDetail"></div>
  <button id="goHomeBtn">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <hr>
  <h2>ğŸ’¬ ëŒ“ê¸€</h2>
  <ul id="commentList"></ul>
  <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
  <button id="addCommentBtn">ëŒ“ê¸€ ì‘ì„±</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp({
      apiKey: "AIzaSyDfrvgcAed9VvS5MFXVZFIxch8aCAfMp1w",
      authDomain: "k-reptilewiki-1f09f.firebaseapp.com",
      projectId: "k-reptilewiki-1f09f"
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const postId = params.get("id");

    if (!postId) {
      document.getElementById("postDetail").textContent = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
    } else {
      loadPost();
      loadComments();
    }

    // ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPost() {
      const snap = await getDoc(doc(db, "wiki_posts", postId));
      const div = document.getElementById("postDetail");
      if (!snap.exists()) {
        div.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      const data = snap.data();

      div.innerHTML = `
        <h2>${data.title}</h2>
        <div>${data.content}</div>
        <small>ì‘ì„±ì: ${data.author} | ${new Date(data.time.toDate()).toLocaleString()}</small><br>
      `;

      // ì¢‹ì•„ìš” ë²„íŠ¼
      const likeBtn = document.createElement("button");
      div.appendChild(likeBtn);
      await updateLikeCount(postId, likeBtn);

      likeBtn.onclick = async () => {
        const user = auth.currentUser;
        if (!user) {
          alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•˜ì…”ì•¼ í•©ë‹ˆë‹¤");
          return;
        }
        const likeId = `${postId}_${user.uid}`;
        const likeRef = doc(db, "post_likes", likeId);
        const likeSnap = await getDoc(likeRef);
        if (likeSnap.exists()) {
          alert("ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!");
        } else {
          await setDoc(likeRef, {
            postId,
            userId: user.uid,
            createdAt: serverTimestamp()
          });
          await updateLikeCount(postId, likeBtn);
        }
      };

      // ì‚­ì œ ë²„íŠ¼
      const user = auth.currentUser;
      if (user && user.uid === data.uid) {
        const btn = document.createElement("button");
        btn.textContent = "ê¸€ ì‚­ì œ";
        btn.onclick = () => deletePost(postId);
        div.appendChild(btn);
      }
    }

    async function updateLikeCount(postId, btn) {
      const q = query(collection(db, "post_likes"), where("postId", "==", postId));
      const snap = await getDocs(q);
      btn.textContent = `â¤ï¸ ${snap.size}`;
    }

    // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadComments() {
      const q = query(collection(db, "wiki_comments"), where("postId", "==", postId));
      const snap = await getDocs(q);
      const ul = document.getElementById("commentList");
      ul.innerHTML = "";
      if (snap.empty) {
        ul.textContent = "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      snap.forEach(c => {
        const data = c.data();
        const li = document.createElement("li");
        li.innerHTML = `<p>${data.content}</p><small>${data.author} | ${new Date(data.time.toDate()).toLocaleString()}</small>`;
        ul.appendChild(li);
      });
    }

    // ëŒ“ê¸€ ì‘ì„±
    document.getElementById("addCommentBtn").onclick = async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•˜ì…”ì•¼ í•©ë‹ˆë‹¤");
        return;
      }
      const content = document.getElementById("commentInput").value.trim();
      if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");

      await addDoc(collection(db, "wiki_comments"), {
        postId,
        content,
        author: user.email,
        uid: user.uid,
        time: serverTimestamp()
      });
      document.getElementById("commentInput").value = "";
      loadComments();
    };

    // ê¸€ ì‚­ì œ
    async function deletePost(id) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db, "wiki_posts", id));
      alert("ì‚­ì œ ì™„ë£Œ");
      location.href = "index.html";
    }

    document.getElementById("goHomeBtn").onclick = () => location.href="index.html";
  </script>
</body>
</html>
