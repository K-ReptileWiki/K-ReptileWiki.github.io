<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ¦ K-ReptileWiki ê¸€ ìƒì„¸</h1>

  <!-- ê¸€ ìƒì„¸ ì˜ì—­ -->
  <div id="postDetail" class="editor-container"></div>

  <!-- ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
  <button id="goHomeBtn">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <hr>
  <h2>ğŸ’¬ ëŒ“ê¸€</h2>
  <ul id="commentList"></ul>

  <!-- ëŒ“ê¸€ ì…ë ¥ -->
  <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
  <button id="addCommentBtn">ëŒ“ê¸€ ì‘ì„±</button>

  <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://cpaikpjzlzzujwfgnanb.supabase.co",
      "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB"
    );

    document.addEventListener("DOMContentLoaded", async () => {
      console.log("âœ… DOMContentLoaded ì‹¤í–‰ë¨");

      // ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸
      const { data: userRes, error: userError } = await supabase.auth.getUser();
      console.log("ğŸ” getUser ê²°ê³¼:", userRes, userError);

      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      console.log("ğŸ” getSession ê²°ê³¼:", session, sessionError);

      const currentUser = userRes?.user ?? null;
      console.log("ğŸ‘¤ currentUser:", currentUser);

      // URLì—ì„œ ê¸€ id ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(location.search);
      const postId = params.get("id");
      console.log("ğŸ“Œ postId:", postId);

      const postDetail = document.getElementById("postDetail");
      const commentList = document.getElementById("commentList");
      const commentInput = document.getElementById("commentInput");
      const addCommentBtn = document.getElementById("addCommentBtn");
      const goHomeBtn = document.getElementById("goHomeBtn");

      if (!postId) {
        postDetail.textContent = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ê¸€ IDê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      await loadPost(postId, currentUser);
      await loadComments(postId);

      // ëŒ“ê¸€ ì‘ì„± ì´ë²¤íŠ¸
      addCommentBtn.onclick = async () => {
        console.log("ğŸ“ ëŒ“ê¸€ ì‘ì„± ì‹œë„, currentUser:", currentUser);
        const content = commentInput.value.trim();
        if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
        if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");

        const { error } = await supabase.from("wiki_comments").insert([{
          post_id: postId,
          content,
          author: currentUser.email ?? "ìµëª…",
          uid: currentUser.id,
          time: new Date().toISOString()
        }]);

        if (error) {
          console.error("âŒ ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:", error);
          alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: " + error.message);
        } else {
          console.log("âœ… ëŒ“ê¸€ ì‘ì„± ì„±ê³µ");
          commentInput.value = "";
          loadComments(postId);
        }
      };

      goHomeBtn.onclick = () => {
        console.log("ğŸ  ë©”ì¸ìœ¼ë¡œ ì´ë™");
        window.location.href = "index.html";
      };
    });

    // ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPost(postId, currentUser) {
      console.log("ğŸ“– ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„:", postId);
      const { data, error } = await supabase
        .from("wiki_posts")
        .select("*")
        .eq("id", postId)
        .single();

      console.log("ğŸ” ê¸€ ë°ì´í„°:", data, "ì—ëŸ¬:", error);

      const div = document.getElementById("postDetail");
      if (error || !data) {
        div.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      let imgHtml = "";
      if (data.images && Array.isArray(data.images)) {
        imgHtml = data.images.map(url => `<img src="${url}" class="species-image">`).join("");
      }

      div.innerHTML = `
        <h2>${data.title}</h2>
        <div>${data.content}</div>
        ${imgHtml}
        <small>ì‘ì„±ì: ${data.author ?? "ìµëª…"} | ${new Date(data.time).toLocaleString()}</small><br>
      `;

      // ì¢‹ì•„ìš” ë²„íŠ¼ (post_likes í…Œì´ë¸” ê¸°ë°˜)
      const likeBtn = document.createElement("button");
      div.appendChild(likeBtn);
      await updateLikeCount(postId, likeBtn);

      likeBtn.onclick = async () => {
        console.log("â¤ï¸ ì¢‹ì•„ìš” í´ë¦­, currentUser:", currentUser);
        if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
        const { error } = await supabase
          .from("post_likes")
          .insert([{ post_id: postId, user_id: currentUser.id }]);
        if (error) {
          console.error("âŒ ì¢‹ì•„ìš” ì‹¤íŒ¨:", error);
          if (error.code === "23505") {
            alert("ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!");
          } else {
            alert("ì¢‹ì•„ìš” ì‹¤íŒ¨: " + error.message);
          }
        } else {
          console.log("âœ… ì¢‹ì•„ìš” ì„±ê³µ");
          await updateLikeCount(postId, likeBtn);
        }
      };

      // ì‚­ì œ ë²„íŠ¼
      if (currentUser && currentUser.id === data.uid) {
        const btn = document.createElement("button");
        btn.className = "delete-btn";
        btn.textContent = "ê¸€ ì‚­ì œ";
        btn.onclick = () => deletePost(data.id);
        div.appendChild(btn);
      }
    }

    // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
    async function updateLikeCount(postId, btn) {
      console.log("ğŸ”„ ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸:", postId);
      const { count, error } = await supabase
        .from("post_likes")
        .select("*", { count: "exact", head: true })
        .eq("post_id", postId);

      console.log("â¤ï¸ ì¢‹ì•„ìš” ìˆ˜:", count, "ì—ëŸ¬:", error);

      if (!error) {
        btn.textContent = `â¤ï¸ ${count}`;
      }
    }

    // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadComments(postId) {
      console.log("ğŸ’¬ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°:", postId);
      const { data, error } = await supabase
        .from("wiki_comments")
        .select("*")
        .eq("post_id", postId)
        .order("time", { ascending: false });

      console.log("ğŸ” ëŒ“ê¸€ ë°ì´í„°:", data, "ì—ëŸ¬:", error);

      const ul = document.getElementById("commentList");
      ul.innerHTML = "";

      if (error) {
        ul.textContent = "ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
        return;
      }
      if (!data || data.length === 0) {
        ul.textContent = "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      data.forEach(c => {
        const li = document.createElement("li");
        li.className = "comment-card";
        li.innerHTML = `
          <p>${c.content}</p>
          <small>${c.author ?? "ìµëª…"} | ${new Date(c.time).toLocaleString()}</small><br>
        `;
        ul.appendChild(li);
      });
    }

    // ê¸€ ì‚­ì œ
    async function deletePost(id) {
      console.log("ğŸ—‘ï¸ ê¸€ ì‚­ì œ ì‹œë„:", id);
      if (!confirm("ì •ë§ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { error } = await supabase.from("wiki_posts").delete().eq("id", id);
      if (error) {
        console.error("âŒ ê¸€ ì‚­ì œ ì‹¤íŒ¨:", error);
        return alert("ê¸€ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
      }
      alert("ê¸€ ì‚­ì œ ì™„ë£Œ");
      location.href = "index.html";
    }
  </script>
</body>
</html>
