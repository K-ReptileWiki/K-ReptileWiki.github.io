<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background:#f9fafb; }
    .container { max-width:900px; margin:20px auto; padding:20px; }
    .post-detail {
      background:white; padding:30px; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px;
    }
    .post-detail img {
      max-width:100%;
      height:auto;
      border-radius:8px;
      margin:10px 0;
      display:block;
    }
    .post-meta {
      color:#6b7280; font-size:14px; margin:15px 0;
      padding:10px; background:#f3f4f6; border-radius:4px;
    }
    .post-stats { display:flex; gap:15px; margin:15px 0; }
    .stat-item {
      background:#f3f4f6; padding:8px 12px;
      border-radius:6px; font-size:14px;
    }
    .btn {
      padding:8px 16px; border:none; border-radius:6px;
      cursor:pointer; font-weight:bold; margin-right:10px;
    }
    .btn-primary { background:#2563eb; color:white; }
    .btn-danger { background:#f87171; color:white; }
    .btn-warning { background:#fbbf24; color:white; }
    .btn-secondary { background:#6b7280; color:white; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ¦ K-ReptileWiki</h1>

  <div id="postDetail" class="post-detail">ë¡œë”© ì¤‘...</div>
  <button id="goHomeBtn" class="btn btn-secondary">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <hr style="margin:30px 0;">

  <div id="versionSection" class="post-detail">
    <h2>ğŸ“œ ë²„ì „ íˆìŠ¤í† ë¦¬</h2>
    <div id="versionList">ë¡œë”© ì¤‘...</div>
  </div>

  <hr style="margin:30px 0;">

  <div class="post-detail">
    <h2>ğŸ’¬ ëŒ“ê¸€</h2>
    <div id="commentList">ë¡œë”© ì¤‘...</div>
    <textarea id="commentInput" style="width:100%;min-height:80px;"></textarea>
    <button id="addCommentBtn" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
  </div>
</div>

<script type="module">
import { supabaseService } from "./js/supabase.js";

const postId = new URLSearchParams(location.search).get("id");
if (!postId) location.href = "index.html";

let currentVersion = null;

async function init() {
  await supabaseService.waitForAuth();
  await supabaseService.recordView(postId);
  await loadPost();
  await loadVersions();
  await loadComments();
}

async function loadPost() {
  const div = document.getElementById("postDetail");
  const res = await supabaseService.getPost(postId);

  if (!res.success) {
    div.textContent = "ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  const post = res.data;
  currentVersion = post.version;

  const viewCount = await supabaseService.getViewCount(postId);
  const likeCount = await supabaseService.getLikeCount(postId);

  div.innerHTML = `
    <h2>${post.title}</h2>

    <div class="post-meta">
      ë²„ì „ ${post.version} |
      ì‘ì„±ì ${post.author ?? "ìµëª…"} |
      ${new Date(post.time).toLocaleString()}
    </div>

    <div class="post-stats">
      <div class="stat-item">ğŸ‘€ ì¡°íšŒ ${viewCount}</div>
      <div class="stat-item">â¤ï¸ ì¢‹ì•„ìš” <span id="likeCount">${likeCount}</span></div>
    </div>

    <!-- âœ… ì´ë¯¸ì§€ í¬í•¨ëœ Quill HTMLë§Œ ì¶œë ¥ -->
    <div class="ql-editor">
      ${post.content}
    </div>

    <div style="margin-top:20px;">
      <button id="likeBtn" class="btn btn-primary">â¤ï¸ ì¢‹ì•„ìš”</button>
      <span id="actionBtns"></span>
    </div>
  `;

  setupLikeButton();
  setupActionButtons(post);
}

function setupActionButtons(post) {
  if (!supabaseService.isLoggedIn()) return;
  const { user } = supabaseService.getCurrentUser();
  if (user.id !== post.uid) return;

  const box = document.getElementById("actionBtns");

  const editBtn = document.createElement("button");
  editBtn.className = "btn btn-warning";
  editBtn.textContent = "âœï¸ ìˆ˜ì •";
  editBtn.onclick = () => location.href = `edit.html?id=${postId}`;

  const delBtn = document.createElement("button");
  delBtn.className = "btn btn-danger";
  delBtn.textContent = "ğŸ—‘ï¸ ì‚­ì œ";
  delBtn.onclick = async () => {
    if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    await supabaseService.deletePost(postId);
    location.href = "index.html";
  };

  box.append(editBtn, delBtn);
}

async function setupLikeButton() {
  const btn = document.getElementById("likeBtn");
  btn.onclick = async () => {
    if (!supabaseService.isLoggedIn()) {
      alert("ë¡œê·¸ì¸ í•„ìš”");
      location.href = "login.html";
      return;
    }
    await supabaseService.toggleLike(postId);
    document.getElementById("likeCount").textContent =
      await supabaseService.getLikeCount(postId);
  };
}

async function loadVersions() {
  const div = document.getElementById("versionList");
  const res = await supabaseService.getPostVersions(postId);

  if (!res.success || !res.data?.length) {
    div.textContent = "ë²„ì „ ì—†ìŒ";
    return;
  }

  div.innerHTML = "";
  res.data.forEach(v => {
    const d = document.createElement("div");
    d.style.cursor = "pointer";
    d.style.margin = "10px 0";
    d.textContent = `ë²„ì „ ${v.version_number} (${v.action})`;
    d.onclick = () => viewVersion(v.version_number);
    div.appendChild(d);
  });
}

async function viewVersion(version) {
  const res = await supabaseService.getPostVersion(postId, version);
  if (!res.success) return;

  const v = res.data;
  const modal = document.createElement("div");
  modal.style.cssText =
    "position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;";
  modal.innerHTML = `
    <div style="background:white;padding:30px;max-width:800px;max-height:80vh;overflow:auto;">
      <h2>${v.title} (v${v.version_number})</h2>
      <div class="ql-editor">${v.content}</div>
      <button id="closeModal" class="btn btn-secondary">ë‹«ê¸°</button>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector("#closeModal").onclick = () => modal.remove();
}

async function loadComments() {
  const div = document.getElementById("commentList");
  const res = await supabaseService.getComments(postId);

  if (!res.success || !res.data?.length) {
    div.textContent = "ëŒ“ê¸€ ì—†ìŒ";
    return;
  }

  div.innerHTML = "";
  res.data.forEach(c => {
    const d = document.createElement("div");
    d.textContent = `${c.author ?? "ìµëª…"}: ${c.content}`;
    div.appendChild(d);
  });
}

document.getElementById("addCommentBtn").onclick = async () => {
  const input = document.getElementById("commentInput");
  if (!input.value.trim()) return;
  await supabaseService.addComment(postId, input.value);
  input.value = "";
  loadComments();
};

document.getElementById("goHomeBtn").onclick = () => location.href = "index.html";

init();
</script>
</body>
</html>
