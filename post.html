<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background:#f9fafb; }
    .container { max-width:900px; margin:20px auto; padding:20px; }
    .post-detail {
      background:white; padding:30px; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px;
    }
    .post-detail img {
      max-width:100%;
      height:auto;
      border-radius:8px;
      margin:10px 0;
      display:block;
    }
    .post-meta {
      color:#6b7280; font-size:14px; margin:15px 0;
      padding:10px; background:#f3f4f6; border-radius:4px;
    }
    .post-stats { display:flex; gap:15px; margin:15px 0; }
    .stat-item {
      background:#f3f4f6; padding:8px 12px;
      border-radius:6px; font-size:14px;
    }
    .btn {
      padding:8px 16px; border:none; border-radius:6px;
      cursor:pointer; font-weight:bold; margin-right:10px;
      transition:0.2s;
    }
    .btn:hover { transform:translateY(-2px); }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .btn-primary { background:#2563eb; color:white; }
    .btn-danger { background:#f87171; color:white; }
    .btn-warning { background:#fbbf24; color:white; }
    .btn-secondary { background:#6b7280; color:white; }
    .btn-success { background:#10b981; color:white; }
    
    .deleted-notice {
      background:#fee2e2;
      border:2px solid #ef4444;
      padding:20px;
      border-radius:8px;
      text-align:center;
      margin-bottom:20px;
    }
    .deleted-notice h3 {
      color:#dc2626;
      margin:0 0 10px 0;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ¦ K-ReptileWiki</h1>

  <div id="deletedNotice"></div>
  <div id="postDetail" class="post-detail">ë¡œë”© ì¤‘...</div>
  <button id="goHomeBtn" class="btn btn-secondary">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

  <hr style="margin:30px 0;">

  <div id="versionSection" class="post-detail">
    <h2>ğŸ“œ ë²„ì „ íˆìŠ¤í† ë¦¬</h2>
    <div id="versionList">ë¡œë”© ì¤‘...</div>
  </div>

  <hr style="margin:30px 0;">

  <div class="post-detail">
    <h2>ğŸ’¬ ëŒ“ê¸€</h2>
    <div id="commentList">ë¡œë”© ì¤‘...</div>
    <textarea id="commentInput" style="width:100%;min-height:80px;"></textarea>
    <button id="addCommentBtn" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
  </div>
</div>

<script type="module">
import { supabaseService } from "./js/supabase.js";

const postId = new URLSearchParams(location.search).get("id");
if (!postId) location.href = "index.html";

let currentVersion = null;
let currentPost = null;

async function init() {
  await supabaseService.waitForAuth();
  await supabaseService.recordView(postId);
  await loadPost();
  await loadVersions();
  await loadComments();
}

async function loadPost() {
  const div = document.getElementById("postDetail");
  const noticeDiv = document.getElementById("deletedNotice");
  const res = await supabaseService.getPost(postId);

  if (!res.success) {
    div.textContent = "ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  const post = res.data;
  currentPost = post;
  currentVersion = post.version;

  // ì‚­ì œëœ ê¸€ í‘œì‹œ
  if (post.deleted) {
    noticeDiv.innerHTML = `
      <div class="deleted-notice">
        <h3>âš ï¸ ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤</h3>
        <p>ì´ ê²Œì‹œê¸€ì€ ê´€ë¦¬ìì— ì˜í•´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>
    `;
  }

  const viewCount = await supabaseService.getViewCount(postId);
  const likeCount = await supabaseService.getLikeCount(postId);

  div.innerHTML = `
    <h2>${post.title}</h2>

    <div class="post-meta">
      ë²„ì „ ${post.version} |
      ì‘ì„±ì ${post.author ?? "ìµëª…"} |
      ${new Date(post.time).toLocaleString()}
      ${post.deleted ? '<span style="color:red;font-weight:bold;"> | ì‚­ì œë¨</span>' : ''}
    </div>

    <div class="post-stats">
      <div class="stat-item">ğŸ‘€ ì¡°íšŒ ${viewCount}</div>
      <div class="stat-item">â¤ï¸ ì¢‹ì•„ìš” <span id="likeCount">${likeCount}</span></div>
    </div>

    <div class="ql-editor">
      ${post.content}
    </div>

    <div style="margin-top:20px;">
      <button id="likeBtn" class="btn btn-primary">â¤ï¸ ì¢‹ì•„ìš”</button>
      <span id="actionBtns"></span>
    </div>
  `;

  setupLikeButton();
  setupActionButtons(post);
}

function setupActionButtons(post) {
  const box = document.getElementById("actionBtns");
  const { user, profile } = supabaseService.getCurrentUser();
  
  if (!user) return;

  const isAuthor = user.id === post.uid;
  const isAdmin = profile?.role === "admin" || profile?.role === "owner";

  // ì‘ì„±ì ë²„íŠ¼
  if (isAuthor && !post.deleted) {
    const editBtn = document.createElement("button");
    editBtn.className = "btn btn-warning";
    editBtn.textContent = "âœï¸ ìˆ˜ì •";
    editBtn.onclick = () => location.href = `edit.html?id=${postId}`;

    const delBtn = document.createElement("button");
    delBtn.className = "btn btn-danger";
    delBtn.textContent = "ğŸ—‘ï¸ ì‚­ì œ";
    delBtn.onclick = handleDelete;

    box.append(editBtn, delBtn);
  }

  // ê´€ë¦¬ì ë³µêµ¬ ë²„íŠ¼
  if (isAdmin && post.deleted) {
    const restoreBtn = document.createElement("button");
    restoreBtn.className = "btn btn-success";
    restoreBtn.textContent = "â™»ï¸ ë³µêµ¬";
    restoreBtn.onclick = handleRestore;
    box.appendChild(restoreBtn);
  }
}

async function handleDelete() {
  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    console.log("ğŸ—‘ï¸ ê¸€ ì‚­ì œ ì‹œì‘:", postId);
    
    const result = await supabaseService.deletePost(postId);
    
    if (result.success) {
      console.log("âœ… ê¸€ ì‚­ì œ ì„±ê³µ");
      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "index.html";
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    console.error("âŒ ì‚­ì œ ì‹¤íŒ¨:", error);
    alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
  }
}

async function handleRestore() {
  if (!confirm("ì´ ê¸€ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    console.log("â™»ï¸ ê¸€ ë³µêµ¬ ì‹œì‘:", postId);
    
    const result = await supabaseService.restorePost(postId);
    
    if (result.success) {
      console.log("âœ… ê¸€ ë³µêµ¬ ì„±ê³µ");
      alert("ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    console.error("âŒ ë³µêµ¬ ì‹¤íŒ¨:", error);
    alert("ë³µêµ¬ ì‹¤íŒ¨: " + error.message);
  }
}

async function setupLikeButton() {
  const btn = document.getElementById("likeBtn");
  btn.onclick = async () => {
    if (!supabaseService.isLoggedIn()) {
      alert("ë¡œê·¸ì¸ í•„ìš”");
      location.href = "login.html";
      return;
    }
    
    try {
      await supabaseService.toggleLike(postId);
      const newCount = await supabaseService.getLikeCount(postId);
      document.getElementById("likeCount").textContent = newCount;
    } catch (error) {
      console.error("ì¢‹ì•„ìš” ì˜¤ë¥˜:", error);
      alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  };
}

async function loadVersions() {
  const div = document.getElementById("versionList");
  const res = await supabaseService.getPostVersions(postId);

  if (!res.success || !res.data?.length) {
    div.textContent = "ë²„ì „ ì—†ìŒ";
    return;
  }

  div.innerHTML = "";
  res.data.forEach(v => {
    const d = document.createElement("div");
    d.style.cursor = "pointer";
    d.style.margin = "10px 0";
    d.style.padding = "8px";
    d.style.background = "#f3f4f6";
    d.style.borderRadius = "4px";
    d.textContent = `ë²„ì „ ${v.version_number} (${v.action}) - ${new Date(v.created_at).toLocaleString()}`;
    d.onclick = () => viewVersion(v.version_number);
    div.appendChild(d);
  });
}

async function viewVersion(version) {
  const res = await supabaseService.getPostVersion(postId, version);
  if (!res.success) return;

  const v = res.data;
  const modal = document.createElement("div");
  modal.style.cssText =
    "position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:9999;";
  modal.innerHTML = `
    <div style="background:white;padding:30px;max-width:800px;max-height:80vh;overflow:auto;border-radius:10px;">
      <h2>${v.title} (v${v.version_number})</h2>
      <div class="ql-editor">${v.content}</div>
      <button id="closeModal" class="btn btn-secondary" style="margin-top:15px;">ë‹«ê¸°</button>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector("#closeModal").onclick = () => modal.remove();
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
}

async function loadComments() {
  const div = document.getElementById("commentList");
  const res = await supabaseService.getComments(postId);

  if (!res.success || !res.data?.length) {
    div.innerHTML = '<p style="color:#888;">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  div.innerHTML = "";
  res.data.forEach(c => {
    const { user } = supabaseService.getCurrentUser();
    const isOwner = user?.id === c.uid;

    const d = document.createElement("div");
    d.className = "comment-card";
    d.innerHTML = `
      <p><strong>${c.author ?? "ìµëª…"}</strong></p>
      <p>${c.content}</p>
      <small>${new Date(c.time).toLocaleString()}</small>
      ${isOwner ? `<button class="btn btn-danger" style="font-size:12px;padding:4px 8px;margin-top:5px;" onclick="deleteComment('${c.id}')">ì‚­ì œ</button>` : ''}
    `;
    div.appendChild(d);
  });
}

window.deleteComment = async (commentId) => {
  if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    console.log("ğŸ—‘ï¸ ëŒ“ê¸€ ì‚­ì œ ì‹œì‘:", commentId);
    
    const result = await supabaseService.deleteComment(commentId);
    
    if (result.success) {
      console.log("âœ… ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ");
      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
      await loadComments();
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    console.error("âŒ ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:", error);
    alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
  }
};

document.getElementById("addCommentBtn").onclick = async () => {
  const input = document.getElementById("commentInput");
  const content = input.value.trim();
  
  if (!content) {
    alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
    return;
  }

  if (!supabaseService.isLoggedIn()) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
    location.href = "login.html";
    return;
  }

  try {
    const result = await supabaseService.addComment(postId, content);
    
    if (result.success) {
      input.value = "";
      await loadComments();
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    console.error("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:", error);
    alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: " + error.message);
  }
};

document.getElementById("goHomeBtn").onclick = () => location.href = "index.html";

init();
</script>
</body>
</html>
