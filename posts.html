<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki ê¸€ ìƒì„¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:20px; }
    h1 { color:#2563eb; }
    .post-detail { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .comment-card { background:#fff; padding:15px; margin-bottom:10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
    button { margin:5px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
    .delete-btn { background:#f87171; color:white; }
  </style>
</head>
<body>
  <h1>ğŸ¦ K-ReptileWiki ê¸€ ìƒì„¸</h1>

  <!-- ê¸€ ìƒì„¸ -->
  <div id="postDetail" class="post-detail"></div>

  <hr>
  <h2>ğŸ’¬ ëŒ“ê¸€</h2>
  <ul id="commentList"></ul>

  <!-- ëŒ“ê¸€ ì‘ì„± -->
  <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;height:80px;"></textarea><br>
  <button id="addCommentBtn">ëŒ“ê¸€ ì‘ì„±</button>

  <!-- ê¸€ ìƒì„¸ ë¡œì§ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp({
      apiKey: "AIzaSyDfrvgcAed9VvS5MFXVZFIxch8aCAfMp1w",
      authDomain: "k-reptilewiki-1f09f.firebaseapp.com",
      projectId: "k-reptilewiki-1f09f"
    });
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUserRole = "user"; // ê¸°ë³¸ê°’

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° role ê°€ì ¸ì˜¤ê¸°
    onAuthStateChanged(auth, async user => {
      if (!user) {
        alert("ë¡œê·¸ì¸ í•„ìš”");
        location.href = "login.html";
        return;
      }
      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
          currentUserRole = snap.data().role ?? "user";
        }
        // role í™•ì¸ í›„ ê¸€/ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        loadPost();
        loadComments();
      } catch (e) {
        console.error("role í™•ì¸ ì‹¤íŒ¨:", e);
      }
    });

    // ê¸€ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPost() {
      const params = new URLSearchParams(location.search);
      const postId = params.get("id");
      const snap = await getDoc(doc(db, "wiki_posts", postId));

      const div = document.getElementById("postDetail");
      if (!snap.exists()) {
        div.textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const data = snap.data();
      let imgHtml = "";
      if (data.images && Array.isArray(data.images)) {
        imgHtml = data.images.map(url => `<img src="${url}" style="max-width:200px;margin:5px;">`).join("");
      }

      div.innerHTML = `
        <h2>${data.title}</h2>
        <div>${data.content}</div>
        ${imgHtml}
        <small>ì‘ì„±ì: ${data.author ?? "ìµëª…"} | ${new Date(data.time.toDate()).toLocaleString()}</small><br>
      `;

      // ë³¸ì¸ ê¸€ì´ê±°ë‚˜ ê´€ë¦¬ìë©´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      if (auth.currentUser && (auth.currentUser.uid === data.uid || currentUserRole === "admin")) {
        div.innerHTML += `<button class="delete-btn" onclick="deletePost('${postId}')">ê¸€ ì‚­ì œ</button>`;
      }
    }

    // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadComments() {
      const ul = document.getElementById("commentList");
      ul.innerHTML = "";

      const commentsSnap = await getDocs(collection(db, "wiki_comments"));
      commentsSnap.forEach(c => {
        const data = c.data();
        const li = document.createElement("li");
        const time = data.time?.toDate?.() ?? new Date(data.time);

        li.className = "comment-card";
        li.innerHTML = `
          <p>${data.content}</p>
          <small>${data.author ?? "ìµëª…"} | ${time.toLocaleString()}</small><br>
        `;

        // ë³¸ì¸ ëŒ“ê¸€ì´ê±°ë‚˜ ê´€ë¦¬ìë©´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        if (auth.currentUser && (auth.currentUser.uid === data.uid || currentUserRole === "admin")) {
          li.innerHTML += `<button class="delete-btn" onclick="deleteComment('${c.id}')">ëŒ“ê¸€ ì‚­ì œ</button>`;
        }

        ul.appendChild(li);
      });
    }

    // ê¸€ ì‚­ì œ
    window.deletePost = async (postId) => {
      if (!confirm("ì •ë§ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db, "wiki_posts", postId));
      alert("ê¸€ ì‚­ì œ ì™„ë£Œ");
      location.href = "index.html";
    };

    // ëŒ“ê¸€ ì‚­ì œ
    window.deleteComment = async (commentId) => {
      if (!confirm("ì •ë§ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db, "wiki_comments", commentId));
      alert("ëŒ“ê¸€ ì‚­ì œ ì™„ë£Œ");
      loadComments();
    };
  </script>
</body>
</html>
