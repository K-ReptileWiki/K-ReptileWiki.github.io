<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body {
  font-family: 'Apple SD Gothic Neo','Malgun Gothic',sans-serif;
  background:#f9fafb;
  margin:0;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}
.editor-container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
#editor { height: 420px; }
input#postTitle {
  width: 100%;
  padding: 14px;
  margin-bottom: 15px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 18px;
}
button {
  padding: 12px 22px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
#image-resizer {
  display: none;
  position: absolute;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#image-resizer input { width: 200px; }
#postStatus {
  margin-top: 15px;
  font-size: 14px;
  color: #2563eb;
}
</style>
</head>
<body>

<div id="image-resizer">
  <span style="font-size:12px;">ì´ë¯¸ì§€ ë„ˆë¹„</span><br>
  <input type="range" id="sizeSlider" min="50" max="800" step="10">
  <div id="sizeValue" style="font-size:12px;text-align:center;">300px</div>
</div>

<div class="container">
  <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    <div id="editor"></div>

    <div style="margin-top:20px;display:flex;gap:10px;">
      <button id="postBtn" style="background:#2563eb;color:white;">ë“±ë¡í•˜ê¸°</button>
      <button id="previewBtn" style="background:#10b981;color:white;">ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="cancelBtn" style="background:#6b7280;color:white;">ì·¨ì†Œ</button>
    </div>

    <div id="postStatus"></div>
  </div>

  <div id="previewArea" style="display:none;margin-top:30px;background:white;padding:20px;border-radius:10px;"></div>
</div>

<script type="module">
import { supabaseService, supabase } from "./js/supabase.js";

let quill = null;

/* ===============================
   Quill ì´ˆê¸°í™”
================================ */
function setupQuill() {
  if (!window.Quill) {
    alert("Quill ë¡œë”© ì‹¤íŒ¨");
    return;
  }

  const ImageBlot = Quill.import('formats/image');

  class ResizableImage extends ImageBlot {
    static create(value) {
      const node = super.create();
      const src = typeof value === 'string' ? value : value.src;
      const width = typeof value === 'object' ? value.width : '300';
      node.setAttribute('src', src);
      node.setAttribute('width', width);
      node.style.width = width + 'px';
      return node;
    }
    static value(node) {
      return {
        src: node.getAttribute('src'),
        width: node.getAttribute('width')
      };
    }
  }

  ResizableImage.blotName = 'image';
  ResizableImage.tagName = 'IMG';
  Quill.register(ResizableImage, true);

  quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
    modules: {
      toolbar: [
        ['bold','italic','underline','strike'],
        [{ header: [1,2,3,false] }],
        [{ color: [] }, { background: [] }],
        ['link','image']
      ]
    }
  });

  setupImageUpload();
  setupImageResizer();
}

/* ===============================
   ì´ë¯¸ì§€ ì—…ë¡œë“œ (null ì™„ì „ ë°©ì–´)
================================ */
function setupImageUpload() {
  if (!quill) return;

  const toolbar = quill.getModule('toolbar');
  if (!toolbar) return;

  const BUCKET = "image";

  toolbar.addHandler('image', () => {
    if (!supabaseService.isLoggedIn()) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';

    input.onchange = async () => {
      const file = input.files?.[0];
      if (!file) return;

      const session = supabaseService.getCurrentUser();
      if (!session || !session.user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      const user = session.user;
      const ext = file.name.split('.').pop();
      const fileName = `${Date.now()}.${ext}`;
      const path = `${user.id}/${fileName}`;

      const { error } = await supabase
        .storage.from(BUCKET)
        .upload(path, file);

      if (error) {
        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
        return;
      }

      const { data } = supabase
        .storage.from(BUCKET)
        .getPublicUrl(path);

      const range = quill.getSelection(true) || { index: quill.getLength() };
      quill.insertEmbed(range.index, 'image', {
        src: data.publicUrl,
        width: '300'
      });
      quill.setSelection(range.index + 1);
    };

    input.click();
  });
}

/* ===============================
   ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì € (null ë°©ì–´)
================================ */
function setupImageResizer() {
  if (!quill || !quill.root) return;

  const resizer = document.getElementById("image-resizer");
  const slider = document.getElementById("sizeSlider");
  const value = document.getElementById("sizeValue");
  let targetImg = null;

  quill.root.addEventListener("click", e => {
    if (e.target && e.target.tagName === "IMG") {
      targetImg = e.target;
      const rect = targetImg.getBoundingClientRect();

      resizer.style.display = "block";
      resizer.style.top = window.scrollY + rect.top - 60 + "px";
      resizer.style.left = window.scrollX + rect.left + "px";

      const w = targetImg.getAttribute("width") || 300;
      slider.value = w;
      value.textContent = w + "px";
    } else {
      resizer.style.display = "none";
      targetImg = null;
    }
  });

  slider.oninput = e => {
    if (!targetImg) return;
    const w = e.target.value;
    targetImg.setAttribute("width", w);
    targetImg.style.width = w + "px";
    value.textContent = w + "px";
  };
}

/* ===============================
   DOMContentLoaded
================================ */
window.addEventListener("DOMContentLoaded", async () => {
  await supabaseService.waitForAuth();

  setupQuill();

  const postBtn = document.getElementById("postBtn");
  const previewBtn = document.getElementById("previewBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const status = document.getElementById("postStatus");
  const previewArea = document.getElementById("previewArea");

  if (!supabaseService.isLoggedIn()) {
    status.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    postBtn.disabled = true;
  }

  /* ê¸€ ë“±ë¡ */
  postBtn.onclick = async () => {
    if (!quill) return;

    postBtn.disabled = true;
    status.textContent = "ë¬¸ì„œë¥¼ ë“±ë¡ ì¤‘ì…ë‹ˆë‹¤...";

    const session = supabaseService.getCurrentUser();
    if (!session || !session.user) {
      status.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
      postBtn.disabled = false;
      return;
    }

    const title = document.getElementById("postTitle").value.trim();
    const content = quill.root.innerHTML;

    if (!title) {
      status.textContent = "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.";
      postBtn.disabled = false;
      return;
    }

    if (content === "<p><br></p>") {
      status.textContent = "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
      postBtn.disabled = false;
      return;
    }

    const temp = document.createElement("div");
    temp.innerHTML = content;
    const images = [...temp.querySelectorAll("img")].map(img => img.src);

    const res = await supabaseService.createPost(title, content, images);

    if (res.success) {
      status.style.color = "#10b981";
      status.textContent = "ë¬¸ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!";
      setTimeout(() => {
        location.href = `post.html?id=${res.data.id}`;
      }, 1000);
    } else {
      status.style.color = "#f87171";
      status.textContent = "ë“±ë¡ ì‹¤íŒ¨: " + res.error;
      postBtn.disabled = false;
    }
  };

  /* ë¯¸ë¦¬ë³´ê¸° */
  previewBtn.onclick = () => {
    if (!quill) return;
    previewArea.style.display = "block";
    previewArea.innerHTML =
      `<h2>ë¯¸ë¦¬ë³´ê¸°</h2><hr><div class="ql-editor">${quill.root.innerHTML}</div>`;
    previewArea.scrollIntoView({ behavior: "smooth" });
  };

  /* ì·¨ì†Œ */
  cancelBtn.onclick = () => {
    if (confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")) {
      location.href = "index.html";
    }
  };
});
</script>

</body>
</html>