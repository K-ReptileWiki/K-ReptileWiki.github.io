<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
  body { font-family: 'Apple SD Gothic Neo','Malgun Gothic',sans-serif; background:#f9fafb; margin:0; }
  .container { max-width: 900px; margin: 0 auto; padding: 20px; }
  .editor-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  #editor { height: 420px; background: #fff; }
  input#postTitle { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; box-sizing: border-box; }
  
  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-group { margin-top:20px; display:flex; gap:10px; }
  button { padding: 12px 22px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
  #postBtn { background:#2563eb; }
  #postBtn:disabled { background:#94a3b8; cursor:not-allowed; }
  #previewBtn { background:#10b981; }
  #cancelBtn { background:#6b7280; }

  /* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì € íŒì—… */
  #image-resizer { display: none; position: absolute; z-index: 1000; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  
  /* ìƒíƒœ ë©”ì‹œì§€ì°½ */
  #postStatus { margin-top: 15px; padding: 10px; border-radius: 6px; background: #f1f5f9; font-size: 14px; color: #334155; min-height: 20px; white-space: pre-line; border-left: 4px solid #2563eb; }
</style>
</head>
<body>

<div id="image-resizer">
  <span style="font-size:12px; font-weight:bold;">ì´ë¯¸ì§€ ë„ˆë¹„ ì¡°ì ˆ</span><br>
  <input type="range" id="sizeSlider" min="50" max="800" step="10">
  <div id="sizeValue" style="font-size:12px; text-align:center; margin-top:5px;">300px</div>
</div>

<div class="container">
  <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    
    <div id="editor"></div>

    <div class="btn-group">
      <button id="postBtn">ë“±ë¡í•˜ê¸°</button>
      <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>

    <div id="postStatus">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
  </div>

  <div id="previewArea" style="display:none; margin-top:30px; background:white; padding:20px; border-radius:10px; border:1px solid #ddd;"></div>
</div>

<script type="module">
import { supabaseService, supabase } from "./js/supabase.js";

let quill = null;
const statusEl = document.getElementById("postStatus");

// í™”ë©´ê³¼ ì½˜ì†”ì— ë™ì‹œì— ë¡œê·¸ë¥¼ ì°ëŠ” í•¨ìˆ˜
function log(msg, isError = false) {
  const timestamp = new Date().toLocaleTimeString();
  const logMsg = `[${timestamp}] ${msg}`;
  console.log(logMsg);
  statusEl.innerText += `\n${logMsg}`;
  if(isError) statusEl.style.borderLeftColor = "#ef4444";
}

/* ===============================
   1. Quill ì—ë””í„° ë° ì´ë¯¸ì§€ ì„¤ì •
================================ */
function setupQuill() {
  log("Quill ì´ˆê¸°í™” ì‹œì‘...");
  
  const ImageBlot = Quill.import('formats/image');
  class ResizableImage extends ImageBlot {
    static create(value) {
      log("ì—ë””í„°ì— ì´ë¯¸ì§€ ë…¸ë“œ ìƒì„± ì¤‘...");
      const node = super.create();
      // valueê°€ ê°ì²´ì¼ ë•Œì™€ ë¬¸ìì—´ì¼ ë•Œ ëª¨ë‘ ëŒ€ì‘
      const src = typeof value === 'string' ? value : value.src;
      const width = value.width || '300';
      
      node.setAttribute('src', src);
      node.setAttribute('width', width);
      node.style.width = width + 'px';
      node.style.display = 'block'; // í•œ ì¤„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì •
      return node;
    }
    static value(node) {
      return {
        src: node.getAttribute('src'),
        width: node.getAttribute('width')
      };
    }
  }

  ResizableImage.blotName = 'image';
  ResizableImage.tagName = 'IMG';
  Quill.register(ResizableImage, true);

  quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ëŠ” íˆ´ë°” ì•„ì´ì½˜ìœ¼ë¡œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ color: [] }, { background: [] }],
        ['link', 'image'],
        ['clean']
      ]
    }
  });

  setupImageUpload();
  setupImageResizer();
  log("Quill ì¤€ë¹„ ì™„ë£Œ.");
}

/* ===============================
   2. ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ (Supabase Storage)
================================ */
function setupImageUpload() {
  const toolbar = quill.getModule('toolbar');
  toolbar.addHandler('image', () => {
    log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ë¨.");
    
    if (!supabaseService.isLoggedIn()) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';

    input.onchange = async () => {
      const file = input.files?.[0];
      if (!file) return;

      log(`íŒŒì¼ ì„ íƒë¨: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
      
      try {
        const user = supabaseService.getCurrentUser().user;
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const path = `${user.id}/${fileName}`;

        log("Supabase Storageì— ì—…ë¡œë“œ ì¤‘...");
        const { data: uploadData, error: uploadError } = await supabase
          .storage.from("image")
          .upload(path, file);

        if (uploadError) throw uploadError;

        log("ì—…ë¡œë“œ ì„±ê³µ! Public URL ìƒì„± ì¤‘...");
        const { data: urlData } = supabase.storage.from("image").getPublicUrl(path);
        
        // ì—ë””í„°ì— ì‚½ì…
        const range = quill.getSelection(true);
        quill.insertEmbed(range.index, 'image', {
          src: urlData.publicUrl,
          width: '300'
        });
        quill.setSelection(range.index + 1);
        log("ì—ë””í„°ì— ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.");

      } catch (err) {
        log("ì´ë¯¸ì§€ ì²˜ë¦¬ ì—ëŸ¬: " + err.message, true);
        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
      }
    };
    input.click();
  });
}

/* ===============================
   3. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì € ë¡œì§
================================ */
function setupImageResizer() {
  const resizer = document.getElementById("image-resizer");
  const slider = document.getElementById("sizeSlider");
  const valueLabel = document.getElementById("sizeValue");
  let targetImg = null;

  quill.root.addEventListener("click", e => {
    if (e.target && e.target.tagName === "IMG") {
      targetImg = e.target;
      const rect = targetImg.getBoundingClientRect();
      resizer.style.display = "block";
      resizer.style.top = (window.scrollY + rect.top - 70) + "px";
      resizer.style.left = (window.scrollX + rect.left) + "px";
      
      const currentWidth = targetImg.getAttribute("width") || 300;
      slider.value = currentWidth;
      valueLabel.textContent = currentWidth + "px";
    } else {
      resizer.style.display = "none";
    }
  });

  slider.oninput = (e) => {
    if (targetImg) {
      const val = e.target.value;
      targetImg.setAttribute("width", val);
      targetImg.style.width = val + "px";
      valueLabel.textContent = val + "px";
    }
  };
}

/* ===============================
   4. ê²Œì‹œê¸€ ë“±ë¡ ë¡œì§ (DB Insert)
================================ */
window.addEventListener("DOMContentLoaded", async () => {
  statusEl.innerText = "ì‚¬ìš©ì ì¸ì¦ í™•ì¸ ì¤‘...";
  
  try {
    await supabaseService.waitForAuth();
    if (!supabaseService.isLoggedIn()) {
      log("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.", true);
      document.getElementById("postBtn").disabled = true;
    } else {
      log("ì¸ì¦ ì™„ë£Œ. ì‘ì„±ì: " + (supabaseService.getCurrentUser().data?.nickname || "ìµëª…"));
    }
  } catch(e) {
    log("ì¸ì¦ ì²´í¬ ì˜¤ë¥˜: " + e.message, true);
  }

  setupQuill();

  const postBtn = document.getElementById("postBtn");
  
  postBtn.onclick = async () => {
    const title = document.getElementById("postTitle").value.trim();
    const content = quill.root.innerHTML;

    if (!title || content === "<p><br></p>") {
      alert("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    log("ë°ì´í„° ë“±ë¡ ì‹œì‘...");
    postBtn.disabled = true;
    postBtn.innerText = "ë“±ë¡ ì¤‘...";

    // ì´ë¯¸ì§€ ê²½ë¡œë“¤ë§Œ ë”°ë¡œ ì¶”ì¶œ (ì´ë¯¸ì§€ ê´€ë¦¬ìš©)
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = content;
    const imageUrls = [...tempDiv.querySelectorAll("img")].map(img => img.src);

    try {
      log("Supabase DB Insert ìš”ì²­ ì „ì†¡...");
      const res = await supabaseService.createPost(title, content, imageUrls);
      
      if (res.success) {
        log("âœ… ë“±ë¡ ì„±ê³µ! ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        setTimeout(() => {
          location.href = `post.html?id=${res.data.id}`;
        }, 800);
      } else {
        throw new Error(res.error);
      }
    } catch (err) {
      log("âŒ ë“±ë¡ ì‹¤íŒ¨: " + err.message, true);
      alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
      postBtn.disabled = false;
      postBtn.innerText = "ë“±ë¡í•˜ê¸°";
    }
  };

  // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
  document.getElementById("previewBtn").onclick = () => {
    const area = document.getElementById("previewArea");
    area.style.display = "block";
    area.innerHTML = `<h3>[ë¯¸ë¦¬ë³´ê¸°] ${document.getElementById("postTitle").value}</h3><hr><div class="ql-editor">${quill.root.innerHTML}</div>`;
    area.scrollIntoView({ behavior: "smooth" });
  };

  // ì·¨ì†Œ ë²„íŠ¼
  document.getElementById("cancelBtn").onclick = () => {
    if(confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.href="index.html";
  };
});
</script>
</body>
</html>
