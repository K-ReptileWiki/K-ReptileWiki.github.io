<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <style>
    body { font-family:'Apple SD Gothic Neo','Malgun Gothic',sans-serif; background:#f9fafb; margin:0; }
    .container { max-width:900px; margin:0 auto; padding:20px; }
    .editor-container { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    #editor { height:420px; }
    input { width:100%; padding:14px; margin-bottom:15px; border:1px solid #ddd; border-radius:6px; font-size:18px; }
    button { padding:12px 22px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    #image-resizer { display:none; position:absolute; z-index:1000; background:white; padding:10px; border-radius:8px; border:1px solid #ddd; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    #image-resizer input { width:200px; }
  </style>
</head>
<body>

<div id="image-resizer">
  <span style="font-size:12px;">ì´ë¯¸ì§€ ë„ˆë¹„</span><br>
  <input type="range" id="sizeSlider" min="50" max="800" step="10">
  <div id="sizeValue" style="font-size:12px;text-align:center;">300px</div>
</div>

<div class="container">
  <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    <div id="editor"></div>

    <div style="margin-top:20px;display:flex;gap:10px;">
      <button id="postBtn" style="background:#2563eb;color:white;">ë“±ë¡í•˜ê¸°</button>
      <button id="previewBtn" style="background:#10b981;color:white;">ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="cancelBtn" style="background:#6b7280;color:white;">ì·¨ì†Œ</button>
    </div>
  </div>

  <div id="previewArea" style="display:none;margin-top:30px;background:white;padding:20px;border-radius:10px;"></div>
</div>

<script type="module">
import { supabaseService, supabase } from "./js/supabase.js";

let quill;

/* ===============================
   1ï¸âƒ£ Quill + ì´ë¯¸ì§€ Blot
================================ */
function setupQuill() {
  const ImageBlot = Quill.import('formats/image');

  class ResizableImage extends ImageBlot {
    static create(value) {
      const node = super.create();
      const src = typeof value === 'string' ? value : value.src;
      const width = typeof value === 'object' ? value.width : '300';
      node.setAttribute('src', src);
      node.setAttribute('width', width);
      node.style.width = width + 'px';
      return node;
    }
    static value(node) {
      return { src: node.getAttribute('src'), width: node.getAttribute('width') };
    }
  }

  ResizableImage.blotName = 'image';
  ResizableImage.tagName = 'IMG';
  Quill.register(ResizableImage, true);

  quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
    modules: {
      toolbar: [
        ['bold','italic','underline','strike'],
        [{ header: [1,2,3,false] }],
        [{ color: [] }, { background: [] }],
        ['link','image']
      ]
    }
  });

  setupImageUpload();
  setupImageResizer();
}

/* ===============================
   2ï¸âƒ£ ì´ë¯¸ì§€ ì—…ë¡œë“œ
================================ */
function setupImageUpload() {
  const toolbar = quill.getModule('toolbar');
  const BUCKET = "image";

  toolbar.addHandler('image', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      const user = supabaseService.currentUser;
      if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const ext = file.name.split('.').pop();
      const path = `${user.id}/${Date.now()}.${ext}`;

      const { error } = await supabase.storage.from(BUCKET).upload(path, file);
      if (error) return alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);

      const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);

      const range = quill.getSelection(true);
      quill.insertEmbed(range.index, 'image', { src: data.publicUrl, width:'300' });
      quill.setSelection(range.index + 1);
    };

    input.click();
  });
}

/* ===============================
   3ï¸âƒ£ ì´ë¯¸ì§€ í´ë¦­ â†’ í¬ê¸° ì¡°ì ˆ
================================ */
function setupImageResizer() {
  const resizer = document.getElementById("image-resizer");
  const slider = document.getElementById("sizeSlider");
  const value = document.getElementById("sizeValue");
  let targetImg = null;

  quill.root.addEventListener("click", e => {
    if (e.target.tagName === "IMG") {
      targetImg = e.target;
      const rect = targetImg.getBoundingClientRect();
      resizer.style.display = "block";
      resizer.style.top = window.scrollY + rect.top - 60 + "px";
      resizer.style.left = window.scrollX + rect.left + "px";

      const w = targetImg.getAttribute("width") || 300;
      slider.value = w;
      value.innerText = w + "px";
    } else resizer.style.display = "none";
  });

  slider.oninput = e => {
    if (!targetImg) return;
    const w = e.target.value;
    targetImg.setAttribute("width", w);
    targetImg.style.width = w + "px";
    value.innerText = w + "px";
  };
}

/* ===============================
   4ï¸âƒ£ ê¸€ ë“±ë¡
================================ */
document.getElementById("postBtn").onclick = async () => {
  const title = document.getElementById("postTitle").value.trim();
  const content = quill.root.innerHTML;

  if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
  if (content === "<p><br></p>") return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const user = supabaseService.currentUser;
  if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

  const temp = document.createElement("div");
  temp.innerHTML = content;
  const images = Array.from(temp.querySelectorAll("img")).map(img => img.src);

  const res = await supabaseService.createPost(title, content, images);
  if (res.success) {
    alert("ë¬¸ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    location.href = `post.html?id=${res.data.id}`;
  } else {
    alert("ë“±ë¡ ì‹¤íŒ¨: " + res.error);
  }
};

/* ===============================
   5ï¸âƒ£ ë¯¸ë¦¬ë³´ê¸° / ì·¨ì†Œ
================================ */
document.getElementById("previewBtn").onclick = () => {
  const area = document.getElementById("previewArea");
  area.style.display = "block";
  area.innerHTML = `<h2>ë¯¸ë¦¬ë³´ê¸°</h2><hr><div class="ql-editor">${quill.root.innerHTML}</div>`;
  area.scrollIntoView({ behavior: "smooth" });
};

document.getElementById("cancelBtn").onclick = () => {
  if (confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")) location.href = "index.html";
};

/* ===============================
   ì´ˆê¸°í™”
================================ */
async function initEditor() {
  await supabaseService.waitForAuth(); // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  setupQuill();
}

initEditor();
</script>

</body>
</html>
