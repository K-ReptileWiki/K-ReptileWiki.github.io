<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body { font-family: 'Apple SD Gothic Neo','Malgun Gothic',sans-serif; background:#f9fafb; margin:0; }
.container { max-width: 900px; margin: 0 auto; padding: 20px; }
.editor-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
#editor { height: 420px; background: #fff; }
input#postTitle { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; box-sizing: border-box; }

.btn-group { margin-top:20px; display:flex; gap:10px; }
button { padding: 12px 22px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
#postBtn { background:#2563eb; }
#postBtn:disabled { background:#94a3b8; cursor:not-allowed; }
#previewBtn { background:#10b981; }
#cancelBtn { background:#6b7280; }

#image-resizer { display: none; position: absolute; z-index: 1000; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

/* ì—…ë¡œë“œ ì˜¤ë²„ë ˆì´ */
.upload-overlay {
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  z-index:9999;
  justify-content:center;
  align-items:center;
}
.upload-overlay.active { display:flex; }
.upload-progress {
  background:white;
  padding:30px 40px;
  border-radius:10px;
  text-align:center;
  min-width:320px;
}
.spinner {
  border:4px solid #f3f3f3;
  border-top:4px solid #2563eb;
  border-radius:50%;
  width:50px;
  height:50px;
  animation:spin 0.8s linear infinite;
  margin:0 auto 20px;
}
@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}
.progress-text {
  font-size:16px;
  font-weight:bold;
  color:#1e3a8a;
  margin-bottom:8px;
}
.progress-detail {
  font-size:13px;
  color:#64748b;
}
</style>
</head>
<body>

<!-- ì—…ë¡œë“œ ì˜¤ë²„ë ˆì´ -->
<div id="uploadOverlay" class="upload-overlay">
  <div class="upload-progress">
    <div class="spinner"></div>
    <div class="progress-text" id="progressText">ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</div>
    <div class="progress-detail" id="progressDetail">ì••ì¶• ë° ìµœì í™” ì¤‘</div>
  </div>
</div>

<div id="image-resizer">
  <span style="font-size:12px; font-weight:bold;">ì´ë¯¸ì§€ ë„ˆë¹„ ì¡°ì ˆ</span><br>
  <input type="range" id="sizeSlider" min="50" max="800" step="10">
  <div id="sizeValue" style="font-size:12px; text-align:center; margin-top:5px;">300px</div>
</div>

<div class="container">
  <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    <div id="editor"></div>

    <div class="btn-group">
      <button id="postBtn">ë“±ë¡í•˜ê¸°</button>
      <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>

    <div id="postStatus">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
  </div>

  <div id="previewArea" style="display:none; margin-top:30px; background:white; padding:20px; border-radius:10px; border:1px solid #ddd;"></div>
</div>

<script type="module">
import { supabaseService, supabase } from "./js/supabase.js";

let quill = null;
const statusEl = document.getElementById("postStatus");
const uploadOverlay = document.getElementById("uploadOverlay");
const progressText = document.getElementById("progressText");
const progressDetail = document.getElementById("progressDetail");
let isUploading = false;

function log(msg, isError=false){
  const timestamp = new Date().toLocaleTimeString();
  const text = `[${timestamp}] ${msg}`;
  console.log(text);
  statusEl.innerText += `\n${text}`;
  statusEl.style.borderLeftColor = isError ? "#ef4444" : "#2563eb";
}

function setupQuill(){
  log("Quill ì´ˆê¸°í™”...");
  
  quill = new Quill('#editor',{
    theme:'snow',
    placeholder:"ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ ì—…ë¡œë“œ ê°€ëŠ¥",
    modules:{
      toolbar:{
        container: [
          [{header:[1,2,3,false]}],
          ['bold','italic','underline','strike'],
          [{color:[]},{background:[]}],
          ['link','image'],
          ['clean']
        ],
        handlers: {
          image: handleImageUpload
        }
      }
    }
  });
  
  quill.on('text-change', function(delta, oldDelta, source) {
    if (source === 'user') {
      const images = quill.root.querySelectorAll('img');
      images.forEach(img => {
        if (!img.style.maxWidth) {
          img.style.maxWidth = '300px';
          img.style.height = 'auto';
          img.style.display = 'block';
          img.style.margin = '10px auto';
        }
      });
    }
  });
  
  setupImageResizer();
  log("Quill ì¤€ë¹„ ì™„ë£Œ");
}

// ğŸš€ ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
async function compressImage(file, maxWidth = 1200, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const img = new Image();
      
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // ìµœëŒ€ ë„ˆë¹„ ì œí•œ
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
        canvas.toBlob(
          (blob) => {
            if (!blob) {
              reject(new Error('ì••ì¶• ì‹¤íŒ¨'));
              return;
            }
            
            // ì••ì¶•ëœ íŒŒì¼ ìƒì„±
            const compressedFile = new File(
              [blob], 
              file.name, 
              { type: 'image/jpeg', lastModified: Date.now() }
            );
            
            resolve(compressedFile);
          },
          'image/jpeg',
          quality
        );
      };
      
      img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
      img.src = e.target.result;
    };
    
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    reader.readAsDataURL(file);
  });
}

async function handleImageUpload() {
  if (isUploading) {
    alert("â³ ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ëë‚œ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    log("âš ï¸ ì—…ë¡œë“œ ì§„í–‰ ì¤‘ - ì¤‘ë³µ ì‹œë„ ì°¨ë‹¨");
    return false;
  }

  if(!supabaseService.isLoggedIn()){ 
    alert("ë¡œê·¸ì¸ í•„ìš”"); 
    return false;
  }
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) {
      isUploading = false;
      return;
    }
    
    isUploading = true;
    const originalSize = (file.size / 1024).toFixed(1);
    log(`ì„ íƒ ì´ë¯¸ì§€: ${file.name} (${originalSize}KB)`);
    
    // ì˜¤ë²„ë ˆì´ í‘œì‹œ
    uploadOverlay.classList.add('active');
    progressText.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
    progressDetail.textContent = `ì›ë³¸ í¬ê¸°: ${originalSize}KB`;
    
    try {
      const user = supabaseService.getCurrentUser().user;
      const fileExt = 'jpg'; // ì••ì¶• í›„ í•­ìƒ jpg
      const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
      const path = `${user.id}/${fileName}`;
      
      // ğŸš€ ì´ë¯¸ì§€ ì••ì¶•
      progressDetail.textContent = "ì´ë¯¸ì§€ ì••ì¶• ì¤‘...";
      const compressedFile = await compressImage(file, 1200, 0.8);
      const compressedSize = (compressedFile.size / 1024).toFixed(1);
      const reduction = ((1 - compressedFile.size / file.size) * 100).toFixed(0);
      
      log(`âœ… ì••ì¶• ì™„ë£Œ: ${originalSize}KB â†’ ${compressedSize}KB (${reduction}% ê°ì†Œ)`);
      progressDetail.textContent = `ì••ì¶• ì™„ë£Œ: ${compressedSize}KB (${reduction}% ê°ì†Œ)`;
      
      // ğŸ“¤ ì—…ë¡œë“œ
      progressDetail.textContent = "ì„œë²„ë¡œ ì—…ë¡œë“œ ì¤‘...";
      const {data, error} = await supabase.storage
        .from("image")
        .upload(path, compressedFile, {
          cacheControl: '3600',
          upsert: false
        });
      
      if(error) throw error;
      
      const {data: urlData} = supabase.storage
        .from("image")
        .getPublicUrl(path);
      
      const imageUrl = urlData.publicUrl;
      
      // ì—ë””í„°ì— ì‚½ì…
      const range = quill.getSelection(true) || { index: quill.getLength() };
      quill.insertEmbed(range.index, 'image', imageUrl);
      quill.setSelection(range.index + 1);
      
      log("âœ… ì´ë¯¸ì§€ ì‚½ì… ì™„ë£Œ");
      progressText.textContent = "ì—…ë¡œë“œ ì™„ë£Œ!";
      progressDetail.textContent = `ìµœì¢… í¬ê¸°: ${compressedSize}KB`;
      
      // 0.5ì´ˆ í›„ ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
      setTimeout(() => {
        uploadOverlay.classList.remove('active');
      }, 500);
      
    } catch(e) {
      log("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message, true);
      progressText.textContent = "ì—…ë¡œë“œ ì‹¤íŒ¨";
      progressDetail.textContent = e.message;
      
      setTimeout(() => {
        uploadOverlay.classList.remove('active');
      }, 2000);
      
      alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
    } finally {
      isUploading = false;
    }
  };
  
  input.click();
  return false;
}

function setupImageResizer(){
  const resizer = document.getElementById("image-resizer");
  const slider = document.getElementById("sizeSlider");
  const valueLabel = document.getElementById("sizeValue");
  let targetImg = null;

  quill.root.addEventListener("click", e => {
    if(e.target.tagName === "IMG"){
      targetImg = e.target;
      const rect = targetImg.getBoundingClientRect();
      resizer.style.display = "block";
      resizer.style.top = (window.scrollY + rect.top - 70) + "px";
      resizer.style.left = (window.scrollX + rect.left) + "px";
      
      const currentWidth = targetImg.style.maxWidth ? 
        parseInt(targetImg.style.maxWidth) : 
        targetImg.width;
      
      slider.value = currentWidth || 300;
      valueLabel.textContent = (currentWidth || 300) + "px";
    } else { 
      resizer.style.display = "none"; 
    }
  });

  slider.oninput = e => {
    if(targetImg){
      const val = e.target.value;
      targetImg.style.maxWidth = val + "px";
      targetImg.style.width = val + "px";
      valueLabel.textContent = val + "px";
    }
  };
  
  document.addEventListener("click", e => {
    if(!resizer.contains(e.target) && !quill.root.contains(e.target)){
      resizer.style.display = "none";
    }
  });
}

window.addEventListener("DOMContentLoaded", async () => {
  statusEl.innerText = "ì‚¬ìš©ì ì¸ì¦ í™•ì¸ ì¤‘...";
  
  try {
    await supabaseService.waitForAuth();
    
    if(!supabaseService.isLoggedIn()){
      log("ë¡œê·¸ì¸ í•„ìš”. ë“±ë¡ ë²„íŠ¼ ë¹„í™œì„±í™”", true);
      document.getElementById("postBtn").disabled = true;
    } else {
      const nick = supabaseService.getCurrentUser().data?.nickname || "ìµëª…";
      log(`ë¡œê·¸ì¸ í™•ì¸ ì™„ë£Œ. ì‘ì„±ì: ${nick}`);
    }
  } catch(e) { 
    log("ì¸ì¦ ì˜¤ë¥˜: " + e.message, true); 
  }

  setupQuill();

  // ë“±ë¡ ë²„íŠ¼
  const postBtn = document.getElementById("postBtn");
  postBtn.onclick = async () => {
    const title = document.getElementById("postTitle").value.trim();
    const content = quill.root.innerHTML;
    
    if(!title || content === "<p><br></p>"){ 
      alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"); 
      return; 
    }
    
    postBtn.disabled = true;
    postBtn.innerText = "ë“±ë¡ ì¤‘...";
    
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = content;
    const imageElements = tempDiv.querySelectorAll("img");
    const allImages = [...imageElements].map(img => img.src);
    const images = [...new Set(allImages)];
    
    log(`ğŸ“ ê²Œì‹œê¸€ ë“±ë¡ ì‹œë„`);
    log(`ğŸ“Š ì´ë¯¸ì§€ ${images.length}ê°œ í¬í•¨`);

    try {
      const res = await supabaseService.createPost(title, content, images);
      
      if(res.success){
        log("âœ… ë“±ë¡ ì„±ê³µ! ìƒì„¸ í˜ì´ì§€ ì´ë™");
        setTimeout(() => location.href = `post.html?id=${res.data.id}`, 800);
      } else {
        throw new Error(res.error);
      }
    } catch(e) {
      log("âŒ ë“±ë¡ ì‹¤íŒ¨: " + e.message, true);
      alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
      postBtn.disabled = false;
      postBtn.innerText = "ë“±ë¡í•˜ê¸°";
    }
  };

  // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
  document.getElementById("previewBtn").onclick = () => {
    const area = document.getElementById("previewArea");
    const content = quill.root.innerHTML;
    
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = content;
    const imageCount = tempDiv.querySelectorAll("img").length;
    
    area.style.display = "block";
    area.innerHTML = `
      <h3>[ë¯¸ë¦¬ë³´ê¸°] ${document.getElementById("postTitle").value}</h3>
      <p style="color:#666;font-size:14px;">ì´ë¯¸ì§€ ${imageCount}ê°œ í¬í•¨</p>
      <hr>
      <div class="ql-editor">${content}</div>
    `;
    area.scrollIntoView({behavior:"smooth"});
    
    log(`ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ì´ë¯¸ì§€ ${imageCount}ê°œ)`);
  };

  // ì·¨ì†Œ ë²„íŠ¼
  document.getElementById("cancelBtn").onclick = () => {
    if(confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      location.href = "index.html";
    }
  };
});
</script>
</body>
</html>
