<script type="module">
import { supabaseService, supabase } from "./js/supabase.js";

let quill;

/* ===============================
   1️⃣ Quill + 이미지 Blot
================================ */
function setupQuill() {
  const ImageBlot = Quill.import('formats/image');

  class ResizableImage extends ImageBlot {
    static create(value) {
      const node = super.create();
      const src = typeof value === 'string' ? value : value.src;
      const width = typeof value === 'object' ? value.width : '300';
      node.setAttribute('src', src);
      node.setAttribute('width', width);
      node.style.width = width + 'px';
      return node;
    }
    static value(node) {
      return { src: node.getAttribute('src'), width: node.getAttribute('width') };
    }
  }

  ResizableImage.blotName = 'image';
  ResizableImage.tagName = 'IMG';
  Quill.register(ResizableImage, true);

  quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: "내용을 입력하세요...",
    modules: {
      toolbar: [
        ['bold','italic','underline','strike'],
        [{ header: [1,2,3,false] }],
        [{ color: [] }, { background: [] }],
        ['link','image']
      ]
    }
  });

  setupImageUpload();
  setupImageResizer();
}

/* ===============================
   2️⃣ 이미지 업로드
================================ */
function setupImageUpload() {
  const toolbar = quill.getModule('toolbar');
  const BUCKET = "image";

  toolbar.addHandler('image', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      if (!supabaseService.isLoggedIn()) return alert("로그인이 필요합니다.");
      const { user } = supabaseService.getCurrentUser();

      const ext = file.name.split('.').pop();
      const fileName = `${Date.now()}.${ext}`;
      const path = `${user.id}/${fileName}`;

      const { error } = await supabase.storage.from(BUCKET).upload(path, file);
      if (error) return alert("이미지 업로드 실패");

      const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
      const range = quill.getSelection(true);
      quill.insertEmbed(range.index, 'image', { src: data.publicUrl, width: '300' });
      quill.setSelection(range.index + 1);
    };

    input.click();
  });
}

/* ===============================
   3️⃣ 이미지 클릭 → 크기 조절
================================ */
function setupImageResizer() {
  const resizer = document.getElementById("image-resizer");
  const slider = document.getElementById("sizeSlider");
  const value = document.getElementById("sizeValue");
  let targetImg = null;

  quill.root.addEventListener("click", e => {
    if (e.target.tagName === "IMG") {
      targetImg = e.target;
      const rect = targetImg.getBoundingClientRect();
      resizer.style.display = "block";
      resizer.style.top = window.scrollY + rect.top - 60 + "px";
      resizer.style.left = window.scrollX + rect.left + "px";
      const w = targetImg.getAttribute("width") || 300;
      slider.value = w;
      value.innerText = w + "px";
    } else {
      resizer.style.display = "none";
    }
  });

  slider.oninput = e => {
    if (!targetImg) return;
    const w = e.target.value;
    targetImg.setAttribute("width", w);
    targetImg.style.width = w + "px";
    value.innerText = w + "px";
  };
}

/* ===============================
   4️⃣ 글 등록
================================ */
document.getElementById("postBtn").onclick = async () => {
  const btn = document.getElementById("postBtn");
  const status = document.getElementById("postStatus");
  btn.disabled = true;
  status.style.color = "#2563eb";
  status.textContent = "문서를 등록 중입니다...";

  try {
    if (!supabaseService.isLoggedIn()) {
      status.textContent = "로그인이 필요합니다.";
      btn.disabled = false;
      return;
    }

    const title = document.getElementById("postTitle").value.trim();
    const content = quill.root.innerHTML;

    if (!title) { status.textContent = "제목을 입력하세요."; btn.disabled=false; return; }
    if (content === "<p><br></p>") { status.textContent = "내용을 입력하세요."; btn.disabled=false; return; }

    const temp = document.createElement("div");
    temp.innerHTML = content;
    const images = Array.from(temp.querySelectorAll("img")).map(img=>img.src);

    const res = await supabaseService.createPost(title, content, images);

    if (res.success) {
      status.style.color = "#10b981";
      status.textContent = "문서가 등록되었습니다! 페이지 이동 중...";
      setTimeout(()=>location.href=`post.html?id=${res.data.id}`, 1000);
    } else {
      status.style.color = "#f87171";
      status.textContent = "등록 실패: " + res.error;
      btn.disabled = false;
    }
  } catch(err) {
    console.error(err);
    status.style.color = "#f87171";
    status.textContent = "오류가 발생했습니다.";
    btn.disabled = false;
  }
};

/* ===============================
   5️⃣ 미리보기 / 취소
================================ */
document.getElementById("previewBtn").onclick = () => {
  const area = document.getElementById("previewArea");
  area.style.display = "block";
  area.innerHTML = `
    <h2>미리보기</h2>
    <hr>
    <div class="ql-editor">${quill.root.innerHTML}</div>
  `;
  area.scrollIntoView({ behavior: "smooth" });
};

document.getElementById("cancelBtn").onclick = () => {
  if (confirm("작성 중인 내용은 저장되지 않습니다.")) location.href = "index.html";
};

/* ===============================
   6️⃣ 초기화
================================ */
async function initPage() {
  // 로그인 상태 대기
  await supabaseService.waitForAuth();

  // Quill 초기화
  setupQuill();

  // 글 작성 버튼 활성화/비활성화
  const postBtn = document.getElementById("postBtn");
  if (!supabaseService.isLoggedIn()) {
    document.getElementById("postStatus").textContent = "로그인이 필요합니다.";
    postBtn.disabled = true;
  } else {
    postBtn.disabled = false;
  }
}

// 페이지 초기화
initPage();
</script>
