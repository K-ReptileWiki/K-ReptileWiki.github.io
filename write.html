<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>

  <div id="image-resizer">
    <div class="resizer-content">
      <span class="resizer-label">ì´ë¯¸ì§€ ë„ˆë¹„</span>
      <input type="range" id="size-slider" min="50" max="800" step="10">
      <span id="size-value">300px</span>
      <button id="size-close" style="background:#6b7280; color:white; border:none; padding:4px 8px; border-radius:4px;">ë‹«ê¸°</button>
    </div>
  </div>

  <div class="container">
    <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>
    <div class="editor-container">
      <div class="form-group">
        <input id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
      </div>
      <div id="editor"></div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button id="postBtn" style="background:#2563eb; color:white; padding:10px 20px; border-radius:6px; cursor:pointer;">ë“±ë¡í•˜ê¸°</button>
        <button id="previewBtn" style="background:#10b981; color:white; padding:10px 20px; border-radius:6px;">ë¯¸ë¦¬ë³´ê¸°</button>
        <button id="cancelBtn" style="background:#6b7280; color:white; padding:10px 20px; border-radius:6px;">ì·¨ì†Œ</button>
      </div>
    </div>
    <div id="previewArea" class="preview" style="display:none; margin-top:20px;"></div>
  </div>

  <script type="module">
    import { supabaseService, supabase } from "./js/supabase.js";

    let quill;

    // A. ì—ë””í„° ì„¤ì • ë° ì´ë¯¸ì§€ í™•ì¥ (ì‚¬ì§„ ì•ˆ ë³´ì„ ë°©ì§€ ì²˜ë¦¬)
    function setupQuill() {
      const ImageBlot = Quill.import('formats/image');
      
      class ResizableImage extends ImageBlot {
        static create(value) {
          const node = super.create(value);
          // valueê°€ ê°ì²´({src, width})ì¸ì§€ ë‹¨ìˆœ URL ë¬¸ìì—´ì¸ì§€ ì²´í¬í•˜ì—¬ src ì„¤ì •
          const src = typeof value === 'string' ? value : value.src;
          const width = typeof value === 'object' ? value.width : '300';
          
          node.setAttribute('src', src);
          if (width) {
            node.setAttribute('width', width);
            node.style.width = width + 'px';
          }
          return node;
        }
        static value(node) {
          return {
            src: node.getAttribute('src'),
            width: node.getAttribute('width')
          };
        }
      }
      Quill.register(ResizableImage, true);

      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'header': [1, 2, 3, false] }],
            [{ 'color': [] }, { 'background': [] }],
            ['link', 'image']
          ]
        },
        placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
      });

      // B. ì´ë¯¸ì§€ í•¸ë“¤ëŸ¬ (íŒŒì¼ ì„ íƒì°½ ê°•ì œ ì‹¤í–‰ + ì—…ë¡œë“œ)
      const toolbar = quill.getModule('toolbar');
      toolbar.addHandler('image', () => {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        
        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;

          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return alert("ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ì´ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");

            const fileExt = file.name.split('.').pop();
            const path = `${user.id}/${Date.now()}.${fileExt}`;

            console.log("ì—…ë¡œë“œ ì‹œì‘...");
            const { error } = await supabase.storage.from("image").upload(path, file);
            if (error) throw error;

            const { data: { publicUrl } } = supabase.storage.from("image").getPublicUrl(path);

            // ì‚¬ì§„ì´ ë³´ì´ë„ë¡ ê°ì²´ í˜•ì‹ìœ¼ë¡œ ì‚½ì…
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', {
              src: publicUrl,
              width: '300'
            }, Quill.Sources.USER);
            
            quill.setSelection(range.index + 1);
          } catch (err) {
            alert("ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: " + err.message);
          }
        };
        input.click();
      });
    }

    // C. ì´ˆê¸°í™” (ê¶Œí•œ ì²´í¬ ë° ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½)
    async function init() {
      setupQuill();
      
      const postBtn = document.getElementById("postBtn");
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: ë²„íŠ¼ íšŒìƒ‰ ë° í´ë¦­ ì œí•œ
        postBtn.style.backgroundColor = "#9ca3af";
        postBtn.style.cursor = "not-allowed";
        postBtn.innerText = "ë¡œê·¸ì¸ í•„ìš”";
        postBtn.onclick = (e) => {
          e.preventDefault();
          alert("ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ì´ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
          location.href = "login.html";
        };
      } else {
        // ë¡œê·¸ì¸ ì‚¬ìš©ì: ì •ìƒ ì‘ë™
        postBtn.onclick = async () => {
          const title = document.getElementById("postTitle").value.trim();
          const content = quill.root.innerHTML;
          if (!title || content === '<p><br></p>') return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          
          postBtn.disabled = true;
          postBtn.innerText = "ì €ì¥ ì¤‘...";
          const res = await supabaseService.createPost(title, content, []);
          if (res.success) {
            alert("ë“±ë¡ ì„±ê³µ!");
            location.href = `post.html?id=${res.data.id}`;
          } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + res.error);
            postBtn.disabled = false;
            postBtn.innerText = "ë“±ë¡í•˜ê¸°";
          }
        };
      }
      setupResizer();
    }

    // D. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë¡œì§
    function setupResizer() {
      const resizer = document.getElementById('image-resizer');
      const slider = document.getElementById('size-slider');
      const sizeVal = document.getElementById('size-value');
      let currentImg = null;

      quill.root.addEventListener('click', (e) => {
        if (e.target.tagName === 'IMG') {
          currentImg = e.target;
          const rect = currentImg.getBoundingClientRect();
          resizer.style.display = 'block';
          resizer.style.top = `${window.scrollY + rect.top - 60}px`;
          resizer.style.left = `${window.scrollX + rect.left}px`;
          const w = currentImg.getAttribute('width') || 300;
          slider.value = w;
          sizeVal.innerText = w + "px";
        } else {
          resizer.style.display = 'none';
        }
      });

      slider.oninput = (e) => {
        if (currentImg) {
          const val = e.target.value;
          currentImg.setAttribute('width', val);
          currentImg.style.width = val + 'px';
          sizeVal.innerText = val + "px";
        }
      };
      document.getElementById("size-close").onclick = () => resizer.style.display = 'none';
    }

    // E. ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
    document.getElementById("previewBtn").onclick = () => {
      const area = document.getElementById("previewArea");
      area.style.display = "block";
      area.innerHTML = `<h2>${document.getElementById("postTitle").value}</h2><hr><div class="ql-editor">${quill.root.innerHTML}</div>`;
      area.scrollIntoView({ behavior: 'smooth' });
    };

    // F. ì·¨ì†Œ ê¸°ëŠ¥
    document.getElementById("cancelBtn").onclick = () => {
      if(confirm("ì‘ì„±ì„ ì¤‘ë‹¨í•˜ê³  ë‚˜ê°ˆê¹Œìš”?")) location.href = "index.html";
    };

    init();
  </script>
</body>
</html>
