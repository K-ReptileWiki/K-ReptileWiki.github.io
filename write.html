<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ê¸€ì“°ê¸° - K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ“ ê¸€ì“°ê¸°</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ì œëª©" style="width:100%;padding:8px;margin-bottom:10px;">
    <div id="editor"></div>
    <input type="file" id="imageUpload" multiple accept="image/*">

    <button id="postBtn">ë“±ë¡</button>
    <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
    <button id="cancelBtn">ì·¨ì†Œ</button>
  </div>

  <div id="previewArea" class="preview" style="display:none;"></div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://cpaikpjzlzzujwfgnanb.supabase.co",
      "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB"
    );

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar: [['bold','italic','underline'],[{header:[1,2,3,false]}],['link','image']] },
      placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
    });

    document.getElementById("postBtn").onclick = async () => {
      const title = document.getElementById("postTitle").value.trim();
      const content = quill.root.innerHTML;
      if (!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•˜ì…”ì•¼ í•©ë‹ˆë‹¤");

      const { data: userInfo } = await supabase.from("users").select("nickname").eq("id", user.id).single();
      const nickname = userInfo?.nickname ?? user.email.split("@")[0];

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ
      const files = document.getElementById("imageUpload").files;
      let imageUrls = [];
      for (const file of files) {
        const filePath = `${user.id}/${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage.from("wiki-images").upload(filePath, file);
        if (!uploadError) {
          const { data: publicUrl } = supabase.storage.from("wiki-images").getPublicUrl(filePath);
          imageUrls.push(publicUrl.publicUrl);
        }
      }

      // ê¸€ ë“±ë¡ (id ì»¬ëŸ¼ ì‚¬ìš©)
      const { data, error } = await supabase.from("wiki_posts").insert([{
        id: crypto.randomUUID(),   // âœ… PK ì»¬ëŸ¼ëª…ì€ id
        title,
        content,
        author: nickname,
        uid: user.id,
        time: new Date().toISOString(),
        images: imageUrls
      }]).select();

      if (error) {
        alert("ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + error.message);
      } else {
        alert("ê¸€ì´ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = `post.html?id=${data[0].id}`; // âœ… id ê¸°ì¤€ ì´ë™
      }
    };

    document.getElementById("cancelBtn").onclick = () => location.href="index.html";
    document.getElementById("previewBtn").onclick = () => {
      const title = document.getElementById("postTitle").value.trim();
      const content = quill.root.innerHTML;
      const previewArea = document.getElementById("previewArea");
      previewArea.style.display = "block";
      previewArea.innerHTML = `<h3>${title||"(ì œëª© ì—†ìŒ)"}</h3><div>${content||"(ë‚´ìš© ì—†ìŒ)"}</div>`;
    };
  </script>
</body>
</html>
