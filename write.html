<script type="module">
  import { supabaseService, supabase } from "./js/supabase.js";

  // 1. ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆì„ ìœ„í•œ Quill Blot í™•ì¥
  const ImageBlot = Quill.import('formats/image');
  class ResizableImage extends ImageBlot {
    static create(value) {
      let node = super.create(value);
      node.setAttribute('src', typeof value === 'string' ? value : value.src);
      if (value.width) {
        node.setAttribute('width', value.width);
        node.style.width = value.width + 'px';
      }
      return node;
    }
    static value(node) {
      return { src: node.getAttribute('src'), width: node.getAttribute('width') };
    }
  }
  Quill.register(ResizableImage, true);

  // 2. Quill ì´ˆê¸°í™” (ì´ë¯¸ì§€ í•¸ë“¤ëŸ¬ ë“±ë¡)
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: {
        container: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'header': [1, 2, 3, false] }],
          [{ 'color': [] }, { 'background': [] }],
          ['link', 'image']
        ],
        handlers: { image: imageHandler }
      }
    },
    placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
  });

  // 3. ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ë³´ë‚´ì£¼ì‹  supabaseService í™œìš©)
  async function imageHandler() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.click();

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      try {
        // ì›ë˜ ì½”ë“œì˜ waitForAuth() ì‚¬ìš©í•˜ì—¬ ìœ ì € ì²´í¬
        const user = await supabaseService.waitForAuth();
        if (!user) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          return;
        }

        console.log("ğŸ“¤ 'image' ë²„í‚·ìœ¼ë¡œ ì—…ë¡œë“œ ì‹œë„ ì¤‘...");

        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const path = `${user.id}/${fileName}`;

        // supabaseService.client(=supabase)ë¥¼ ì‚¬ìš©í•˜ì—¬ 'image' ë²„í‚·ì— ì—…ë¡œë“œ
        const { data, error: uploadError } = await supabase.storage
          .from("image") 
          .upload(path, file);

        if (uploadError) throw uploadError;

        // URL ê°€ì ¸ì˜¤ê¸°
        const { data: { publicUrl } } = supabase.storage
          .from("image")
          .getPublicUrl(path);

        console.log("âœ… ì—…ë¡œë“œ ì„±ê³µ:", publicUrl);

        // ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì… (ê¸°ë³¸ë„ˆë¹„ 300px)
        const range = quill.getSelection();
        quill.insertEmbed(range.index, 'image', { src: publicUrl, width: '300' });
        quill.setSelection(range.index + 1);

      } catch (err) {
        console.error("âŒ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
      }
    };
  }

  // 4. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ìŠ¬ë¼ì´ë” ë¡œì§
  let currentImg = null;
  const resizer = document.getElementById('image-resizer');
  const slider = document.getElementById('size-slider');
  const sizeVal = document.getElementById('size-value');

  quill.root.addEventListener('click', (e) => {
    if (e.target.tagName === 'IMG') {
      currentImg = e.target;
      const rect = currentImg.getBoundingClientRect();
      const currentWidth = parseInt(currentImg.getAttribute('width')) || currentImg.clientWidth;

      resizer.style.display = 'block';
      resizer.style.top = `${window.scrollY + rect.top - 60}px`;
      resizer.style.left = `${window.scrollX + rect.left}px`;

      slider.value = currentWidth;
      sizeVal.innerText = `${currentWidth}px`;
    } else {
      resizer.style.display = 'none';
    }
  });

  slider.addEventListener('input', (e) => {
    if (currentImg) {
      const val = e.target.value;
      currentImg.setAttribute('width', val);
      currentImg.style.width = `${val}px`;
      sizeVal.innerText = `${val}px`;
    }
  });

  document.getElementById('size-close').addEventListener('click', () => { resizer.style.display = 'none'; });

  // 5. ì´ˆê¸°í™” ë° í˜ì´ì§€ ë³´í˜¸
  async function init() {
    const loading = document.getElementById("loadingOverlay");
    const user = await supabaseService.waitForAuth();
    if (loading) loading.style.display = "none";
    if (!user) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "login.html";
    }
  }
  init();

  // 6. ê²Œì‹œê¸€ ë“±ë¡ (ì›ë˜ ì½”ë“œì˜ createPost í™œìš©)
  document.getElementById("postBtn").addEventListener("click", async () => {
    const title = document.getElementById("postTitle").value.trim();
    const content = quill.root.innerHTML;

    if (!title || content === '<p><br></p>') {
      alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const btn = document.getElementById("postBtn");
    btn.disabled = true;
    btn.innerText = "ì €ì¥ ì¤‘...";

    // ì´ë¯¸ì§€ëŠ” ë³¸ë¬¸ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë¹ˆ ë°°ì—´ë¡œ ì „ì†¡í•˜ê±°ë‚˜, 
    // ë³¸ë¬¸ì—ì„œ ì´ë¯¸ì§€ srcë§Œ ì¶”ì¶œí•˜ì—¬ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    const res = await supabaseService.createPost(title, content, []);
    
    if (res.success) {
      alert("ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
      location.href = `post.html?id=${res.data.id}`;
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + res.error);
      btn.disabled = false;
      btn.innerText = "ë“±ë¡í•˜ê¸°";
    }
  });
</script>
