<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ê¸€ì“°ê¸° - K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Quill ì—ë””í„° CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <!-- ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ“ ê¸€ì“°ê¸°</h1>

  <div class="editor-container">
    <!-- ì œëª© ì…ë ¥ -->
    <input id="postTitle" placeholder="ì œëª©" style="width:100%;padding:8px;margin-bottom:10px;">

    <!-- Quill ì—ë””í„° -->
    <div id="editor"></div>

    <!-- ë²„íŠ¼ -->
    <button id="postBtn">ë“±ë¡</button>
    <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
    <button id="cancelBtn">ì·¨ì†Œ</button>
  </div>

  <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
  <div id="previewArea" class="preview" style="display:none;"></div>

  <!-- Quill ì—ë””í„° JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://cpaikpjzlzzujwfgnanb.supabase.co";
    const supabaseKey = "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // âœ… Quill ì—ë””í„° ì´ˆê¸°í™” (ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ íˆ´ë°”)
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline', 'strike'],   // êµµê²Œ, ê¸°ìš¸ì„, ë°‘ì¤„, ì·¨ì†Œì„ 
          [{ 'header': [1, 2, 3, false] }],            // ì œëª© í¬ê¸°
          [{ 'color': [] }, { 'background': [] }],     // ê¸€ììƒ‰, ë°°ê²½ìƒ‰
          [{ 'align': [] }],                           // ì •ë ¬
          ['blockquote', 'code-block'],                // ì¸ìš©êµ¬, ì½”ë“œ ë¸”ë¡
          ['link', 'image']                            // ë§í¬, ì´ë¯¸ì§€ ì‚½ì…
        ]
      },
      placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
    });

    // ê¸€ ë“±ë¡ ë²„íŠ¼
    document.getElementById("postBtn").onclick = async () => {
      const title = document.getElementById("postTitle").value.trim();
      const content = quill.root.innerHTML;
      const files = document.getElementById("images").files;

      if (!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
      if (files.length > 3) return alert("ì‚¬ì§„ì€ ìµœëŒ€ 3ì¥ê¹Œì§€ ì²¨ë¶€ ê°€ëŠ¥í•©ë‹ˆë‹¤");

      const imageUrls = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileName = `${Date.now()}_${file.name}`;
        const { error } = await supabase.storage.from("image").upload(fileName, file);
        if (error) {
          alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
          return;
        }
        const { data: publicUrl } = supabase.storage.from("image").getPublicUrl(fileName);
        imageUrls.push(publicUrl.publicUrl);
      }

      // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
      const { data: { user } } = await supabase.auth.getUser();

      const { data, error: insertError } = await supabase
        .from("wiki_posts")
        .insert([{
          title,
          content,
          author: user?.email ?? "ìµëª…",
          uid: user?.id ?? null,
          time: new Date().toISOString(),
          images: imageUrls
        }])
        .select();

      if (insertError) {
        alert("ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + insertError.message);
      } else {
        alert("ê¸€ì´ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
        if (data?.length) {
          location.href = `post.html?id=${data[0].id}`;
        } else {
          location.href = "index.html";
        }
      }
    };

    // ì·¨ì†Œ ë²„íŠ¼
    document.getElementById("cancelBtn").onclick = () => {
      if (confirm("ì‘ì„± ì¤‘ì¸ ê¸€ì„ ì·¨ì†Œí•˜ê³  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        location.href = "index.html";
      }
    };

    // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
    document.getElementById("previewBtn").onclick = () => {
      const title = document.getElementById("postTitle").value.trim();
      const content = quill.root.innerHTML;
      const files = document.getElementById("images").files;

      let imgHtml = "";
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const url = URL.createObjectURL(file);
        imgHtml += `<img src="${url}" style="max-width:200px;margin:5px;">`;
      }

      const previewArea = document.getElementById("previewArea");
      previewArea.style.display = "block";
      previewArea.innerHTML = `
        <h3>${title || "(ì œëª© ì—†ìŒ)"}</h3>
        <div>${content || "(ë‚´ìš© ì—†ìŒ)"}</div>
        <div class="images-preview">${imgHtml}</div>
      `;
    };
  </script>
</body>
</html>
