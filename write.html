<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <style>
    /* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì € ìŠ¤íƒ€ì¼ */
    #image-resizer {
      display: none;
      position: absolute;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 1px solid #ddd;
    }
    .resizer-content { display: flex; align-items: center; gap: 10px; }
    .editor-container { background: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
    #editor { height: 400px; }
    .form-group input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; }
  </style>
</head>
<body>

  <div id="image-resizer">
    <div class="resizer-content">
      <span style="font-size:12px; font-weight:bold;">ë„ˆë¹„ ì¡°ì ˆ</span>
      <input type="range" id="size-slider" min="50" max="800" step="10">
      <span id="size-value" style="font-size:12px;">300px</span>
      <button id="size-close" style="background:#ef4444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">ë‹«ê¸°</button>
    </div>
  </div>

  <div class="container" style="max-width: 900px; margin: 0 auto; padding: 20px;">
    <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>
    
    <div class="editor-container">
      <div class="form-group">
        <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í¬ë ˆìŠ¤í‹°ë“œ ê²Œì½” ì‚¬ìœ¡ë²•)" maxlength="100">
      </div>

      <div id="editor"></div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button id="postBtn" style="background:#2563eb; color:white; padding:12px 24px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ë“±ë¡í•˜ê¸°</button>
        <button id="previewBtn" style="background:#10b981; color:white; padding:12px 24px; border:none; border-radius:6px; cursor:pointer;">ë¯¸ë¦¬ë³´ê¸°</button>
        <button id="cancelBtn" style="background:#6b7280; color:white; padding:12px 24px; border:none; border-radius:6px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>

    <div id="previewArea" class="preview" style="display:none; margin-top:30px; padding:20px; background:white; border:1px solid #ddd; border-radius:8px;"></div>
  </div>

  <script type="module">
    import { supabaseService, supabase } from "./js/supabase.js";

    let quill;

    // A. ì—ë””í„° ì´ˆê¸° ì„¤ì • ë° ì´ë¯¸ì§€ ê¸°ëŠ¥ í™•ì¥
    function setupQuill() {
      const ImageBlot = Quill.import('formats/image');
      
      // ì´ë¯¸ì§€ì— width ì†ì„±ì„ ë¶€ì—¬í•˜ê¸° ìœ„í•œ í™•ì¥ í´ë˜ìŠ¤
      class ResizableImage extends ImageBlot {
        static create(value) {
          const node = super.create(value);
          const src = typeof value === 'string' ? value : value.src;
          const width = typeof value === 'object' ? value.width : '300';
          node.setAttribute('src', src);
          node.setAttribute('width', width);
          node.style.width = width + 'px';
          return node;
        }
        static value(node) {
          return { src: node.getAttribute('src'), width: node.getAttribute('width') };
        }
      }
      Quill.register(ResizableImage, true);

      // ì—ë””í„° ìƒì„±
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'header': [1, 2, 3, false] }],
            [{ 'color': [] }, { 'background': [] }],
            ['link', 'image']
          ]
        },
        placeholder: "ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”..."
      });

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ ê°€ë¡œì±„ê¸°
      const toolbar = quill.getModule('toolbar');
      toolbar.addHandler('image', () => {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        
        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;

          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

            // 1. íŒŒì¼ ì—…ë¡œë“œ
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;
            const path = `${user.id}/${fileName}`;

            const { data, error } = await supabase.storage.from("image").upload(path, file);
            if (error) throw error;

            // 2. ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
            const { data: { publicUrl } } = supabase.storage.from("image").getPublicUrl(path);

            // 3. ì—ë””í„°ì— ì‚½ì… (ê°ì²´ í˜•íƒœë¡œ ì „ë‹¬í•˜ì—¬ width ì •ë³´ í¬í•¨)
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', { src: publicUrl, width: '300' });
            quill.setSelection(range.index + 1);
            
          } catch (err) {
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
          }
        };
        input.click();
      });
    }

    // B. í˜ì´ì§€ ì´ˆê¸°í™” ë° ê¶Œí•œ ì²´í¬
    async function init() {
      setupQuill();
      
      const postBtn = document.getElementById("postBtn");
      const { data: { user } } = await supabase.auth.getUser();

      // 1. ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ ì²˜ë¦¬
      if (!user) {
        postBtn.style.backgroundColor = "#9ca3af";
        postBtn.innerText = "ë¡œê·¸ì¸ í•„ìš”";
        postBtn.onclick = () => {
          alert("ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê¸€ì„ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          location.href = "login.html";
        };
      } else {
        // 2. ê¸€ ë“±ë¡ ë¡œì§
        postBtn.onclick = async () => {
          const title = document.getElementById("postTitle").value.trim();
          const content = quill.root.innerHTML;

          if (!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          if (content === '<p><br></p>') return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

          postBtn.disabled = true;
          postBtn.innerText = "ë¬¸ì„œ ì €ì¥ ì¤‘...";

          // ğŸ”¥ ì¤‘ìš”: ë³¸ë¬¸ ë‚´ ì´ë¯¸ì§€ ì£¼ì†Œ(src)ë¥¼ ëª¨ë‘ ì¶”ì¶œí•˜ì—¬ DBì˜ images ì»¬ëŸ¼ì— ì €ì¥
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = content;
          const imageUrls = Array.from(tempDiv.querySelectorAll('img')).map(img => img.src);

          const res = await supabaseService.createPost(title, content, imageUrls);
          
          if (res.success) {
            alert("ë¬¸ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.href = `post.html?id=${res.data.id}`;
          } else {
            alert("ë“±ë¡ ì‹¤íŒ¨: " + res.error);
            postBtn.disabled = false;
            postBtn.innerText = "ë“±ë¡í•˜ê¸°";
          }
        };
      }
      setupResizer();
    }

    // C. ì´ë¯¸ì§€ í´ë¦­ ì‹œ í¬ê¸° ì¡°ì ˆ ë°” ë…¸ì¶œ
    function setupResizer() {
      const resizer = document.getElementById('image-resizer');
      const slider = document.getElementById('size-slider');
      const sizeVal = document.getElementById('size-value');
      let currentImg = null;

      quill.root.addEventListener('click', (e) => {
        if (e.target.tagName === 'IMG') {
          currentImg = e.target;
          const rect = currentImg.getBoundingClientRect();
          resizer.style.display = 'block';
          resizer.style.top = `${window.scrollY + rect.top - 60}px`;
          resizer.style.left = `${window.scrollX + rect.left}px`;
          
          const currentWidth = currentImg.getAttribute('width') || 300;
          slider.value = currentWidth;
          sizeVal.innerText = currentWidth + "px";
        } else {
          resizer.style.display = 'none';
        }
      });

      slider.oninput = (e) => {
        if (currentImg) {
          const val = e.target.value;
          currentImg.setAttribute('width', val);
          currentImg.style.width = val + 'px';
          sizeVal.innerText = val + "px";
        }
      };
      document.getElementById("size-close").onclick = () => resizer.style.display = 'none';
    }

    // D. ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
    document.getElementById("previewBtn").onclick = () => {
      const title = document.getElementById("postTitle").value;
      const area = document.getElementById("previewArea");
      area.style.display = "block";
      area.innerHTML = `
        <h2 style="margin-top:0;">[ë¯¸ë¦¬ë³´ê¸°] ${title}</h2>
        <hr>
        <div class="ql-editor">${quill.root.innerHTML}</div>
      `;
      area.scrollIntoView({ behavior: 'smooth' });
    };

    // E. ì·¨ì†Œ ë²„íŠ¼
    document.getElementById("cancelBtn").onclick = () => {
      if (confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        location.href = "index.html";
      }
    };

    init();
  </script>
</body>
</html>
