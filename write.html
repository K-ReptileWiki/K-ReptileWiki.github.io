-- ============================================
-- 종 페이지용 좋아요 테이블
-- ============================================
CREATE TABLE IF NOT EXISTS species_likes (
  id BIGSERIAL PRIMARY KEY,
  species_id TEXT NOT NULL,  -- "crested_gecko", "leopard_gecko" 등
  uid UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(species_id, uid)  -- 한 사용자당 한 종에 1개의 좋아요만
);

CREATE INDEX IF NOT EXISTS idx_species_likes_species_id ON species_likes(species_id);
CREATE INDEX IF NOT EXISTS idx_species_likes_uid ON species_likes(uid);

-- RLS 설정
ALTER TABLE species_likes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view species likes"
  ON species_likes FOR SELECT
  USING (true);

CREATE POLICY "Users can insert their own species likes"
  ON species_likes FOR INSERT
  WITH CHECK (auth.uid() = uid);

CREATE POLICY "Users can delete their own species likes"
  ON species_likes FOR DELETE
  USING (auth.uid() = uid);

-- ============================================
-- 종 페이지용 기여 테이블
-- ============================================
CREATE TABLE IF NOT EXISTS species_contributions (
  id BIGSERIAL PRIMARY KEY,
  species_id TEXT NOT NULL,  -- "crested_gecko", "leopard_gecko" 등
  content TEXT NOT NULL,
  uid UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  author TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_species_contributions_species_id ON species_contributions(species_id);
CREATE INDEX IF NOT EXISTS idx_species_contributions_uid ON species_contributions(uid);

-- RLS 설정
ALTER TABLE species_contributions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view species contributions"
  ON species_contributions FOR SELECT
  USING (true);

CREATE POLICY "Users can insert species contributions"
  ON species_contributions FOR INSERT
  WITH CHECK (auth.uid() = uid);

CREATE POLICY "Users can update their own species contributions"
  ON species_contributions FOR UPDATE
  USING (auth.uid() = uid);

CREATE POLICY "Users can delete their own species contributions"
  ON species_contributions FOR DELETE
  USING (auth.uid() = uid);

-- Admins can delete any species contributions
CREATE POLICY "Admins can delete any species contributions"
  ON species_contributions FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );
