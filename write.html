<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body { font-family: 'Apple SD Gothic Neo','Malgun Gothic',sans-serif; background:#f9fafb; margin:0; }
.container { max-width: 900px; margin: 0 auto; padding: 20px; }
.editor-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
#editor { height: 420px; background: #fff; }
input#postTitle { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; box-sizing: border-box; }

.btn-group { margin-top:20px; display:flex; gap:10px; }
button { padding: 12px 22px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
#postBtn { background:#2563eb; }
#postBtn:disabled { background:#94a3b8; cursor:not-allowed; }
#previewBtn { background:#10b981; }
#cancelBtn { background:#6b7280; }
#debugBtn { background:#f97316; }

#image-resizer { display: none; position: absolute; z-index: 1000; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
#postStatus { margin-top: 15px; padding: 10px; border-radius: 6px; background: #f1f5f9; font-size: 14px; color: #334155; min-height: 20px; white-space: pre-line; border-left: 4px solid #2563eb; }
</style>
</head>
<body>

<div id="image-resizer">
  <span style="font-size:12px; font-weight:bold;">ì´ë¯¸ì§€ ë„ˆë¹„ ì¡°ì ˆ</span><br>
  <input type="range" id="sizeSlider" min="50" max="800" step="10">
  <div id="sizeValue" style="font-size:12px; text-align:center; margin-top:5px;">300px</div>
</div>

<div class="container">
  <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    <div id="editor"></div>

    <div class="btn-group">
      <button id="postBtn">ë“±ë¡í•˜ê¸°</button>
      <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="debugBtn">ğŸ” ë””ë²„ê·¸</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>

    <div id="postStatus">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
  </div>

  <div id="previewArea" style="display:none; margin-top:30px; background:white; padding:20px; border-radius:10px; border:1px solid #ddd;"></div>
</div>

<script type="module">
import { supabaseService, supabase } from "./js/supabase.js";

let quill = null;
const statusEl = document.getElementById("postStatus");
let isUploading = false;

// âœ… ë””ë²„ê¹…ì„ ìœ„í•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
window.debugQuill = () => {
  if (!quill) {
    console.log("âŒ Quillì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
    return;
  }
  
  const html = quill.root.innerHTML;
  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = html;
  const images = tempDiv.querySelectorAll("img");
  
  console.log("=== ğŸ” Quill ë””ë²„ê·¸ ì •ë³´ ===");
  console.log("ì „ì²´ HTML:", html);
  console.log("ì´ë¯¸ì§€ ê°œìˆ˜:", images.length);
  console.log("ì´ë¯¸ì§€ URLë“¤:");
  images.forEach((img, i) => {
    console.log(`  [${i+1}] ${img.src}`);
  });
  console.log("=========================");
  
  alert(`ì—ë””í„°ì— ì´ë¯¸ì§€ ${images.length}ê°œê°€ ìˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.`);
};

function log(msg, isError=false){
  const timestamp = new Date().toLocaleTimeString();
  const text = `[${timestamp}] ${msg}`;
  console.log(text);
  statusEl.innerText += `\n${text}`;
  statusEl.style.borderLeftColor = isError ? "#ef4444" : "#2563eb";
}

function setupQuill(){
  log("Quill ì´ˆê¸°í™”...");
  
  // ê¸°ë³¸ Quill ì„¤ì • (ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ ë¸”ë¡¯ ì—†ì´)
  quill = new Quill('#editor',{
    theme:'snow',
    placeholder:"ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ ì—…ë¡œë“œ ê°€ëŠ¥",
    modules:{
      toolbar:{
        container: [
          [{header:[1,2,3,false]}],
          ['bold','italic','underline','strike'],
          [{color:[]},{background:[]}],
          ['link','image'],
          ['clean']
        ],
        handlers: {
          image: handleImageUpload
        }
      }
    }
  });
  
  // âœ… ì´ë¯¸ì§€ ì‚½ì… í›„ ìë™ìœ¼ë¡œ ìŠ¤íƒ€ì¼ ì ìš©
  quill.on('text-change', function(delta, oldDelta, source) {
    if (source === 'user') {
      const images = quill.root.querySelectorAll('img');
      images.forEach(img => {
        if (!img.style.maxWidth) {
          img.style.maxWidth = '300px';
          img.style.height = 'auto';
          img.style.display = 'block';
          img.style.margin = '10px auto';
        }
      });
    }
  });
  
  setupImageResizer();
  log("Quill ì¤€ë¹„ ì™„ë£Œ");
}

async function handleImageUpload() {
  if (isUploading) {
    log("âš ï¸ ì´ë¯¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤");
    return false; // âœ… false ë°˜í™˜ìœ¼ë¡œ ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
  }

  if(!supabaseService.isLoggedIn()){ 
    alert("ë¡œê·¸ì¸ í•„ìš”"); 
    return false;
  }
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) {
      isUploading = false;
      return;
    }
    
    isUploading = true;
    log(`ì„ íƒ ì´ë¯¸ì§€: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
    
    try {
      const user = supabaseService.getCurrentUser().user;
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
      const path = `${user.id}/${fileName}`;
      
      log("ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...");
      
      const {data, error} = await supabase.storage
        .from("image")
        .upload(path, file);
      
      if(error) throw error;
      
      const {data: urlData} = supabase.storage
        .from("image")
        .getPublicUrl(path);
      
      const imageUrl = urlData.publicUrl;
      
      // âœ… í˜„ì¬ ì—ë””í„°ì˜ ì´ë¯¸ì§€ ê°œìˆ˜ í™•ì¸ (ì‚½ì… ì „)
      const imagesBefore = quill.root.querySelectorAll('img').length;
      log(`ğŸ“Š ì‚½ì… ì „ ì´ë¯¸ì§€ ê°œìˆ˜: ${imagesBefore}`);
      
      // âœ… ì»¤ì„œ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
      const range = quill.getSelection(true) || { index: quill.getLength() };
      
      // âœ… ì´ë¯¸ì§€ ì‚½ì…
      quill.insertEmbed(range.index, 'image', imageUrl);
      
      // âœ… ì»¤ì„œ ì´ë™
      quill.setSelection(range.index + 1);
      
      // âœ… ì‚½ì… í›„ ì´ë¯¸ì§€ ê°œìˆ˜ í™•ì¸
      setTimeout(() => {
        const imagesAfter = quill.root.querySelectorAll('img').length;
        log(`ğŸ“Š ì‚½ì… í›„ ì´ë¯¸ì§€ ê°œìˆ˜: ${imagesAfter}`);
        
        if (imagesAfter - imagesBefore > 1) {
          log(`âš ï¸ ê²½ê³ : ì´ë¯¸ì§€ê°€ ${imagesAfter - imagesBefore}ê°œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, true);
        } else {
          log("âœ… ì´ë¯¸ì§€ ì‚½ì… ì™„ë£Œ (1ê°œ)");
        }
      }, 100);
      
    } catch(e) {
      log("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message, true);
      alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
    } finally {
      isUploading = false;
    }
  };
  
  input.click();
  return false; // âœ… ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
}

function setupImageResizer(){
  const resizer = document.getElementById("image-resizer");
  const slider = document.getElementById("sizeSlider");
  const valueLabel = document.getElementById("sizeValue");
  let targetImg = null;

  quill.root.addEventListener("click", e => {
    if(e.target.tagName === "IMG"){
      targetImg = e.target;
      const rect = targetImg.getBoundingClientRect();
      resizer.style.display = "block";
      resizer.style.top = (window.scrollY + rect.top - 70) + "px";
      resizer.style.left = (window.scrollX + rect.left) + "px";
      
      // í˜„ì¬ ë„ˆë¹„ ê°€ì ¸ì˜¤ê¸°
      const currentWidth = targetImg.style.maxWidth ? 
        parseInt(targetImg.style.maxWidth) : 
        targetImg.width;
      
      slider.value = currentWidth || 300;
      valueLabel.textContent = (currentWidth || 300) + "px";
    } else { 
      resizer.style.display = "none"; 
    }
  });

  slider.oninput = e => {
    if(targetImg){
      const val = e.target.value;
      targetImg.style.maxWidth = val + "px";
      targetImg.style.width = val + "px";
      valueLabel.textContent = val + "px";
    }
  };
  
  document.addEventListener("click", e => {
    if(!resizer.contains(e.target) && !quill.root.contains(e.target)){
      resizer.style.display = "none";
    }
  });
}

window.addEventListener("DOMContentLoaded", async () => {
  statusEl.innerText = "ì‚¬ìš©ì ì¸ì¦ í™•ì¸ ì¤‘...";
  
  try {
    await supabaseService.waitForAuth();
    
    if(!supabaseService.isLoggedIn()){
      log("ë¡œê·¸ì¸ í•„ìš”. ë“±ë¡ ë²„íŠ¼ ë¹„í™œì„±í™”", true);
      document.getElementById("postBtn").disabled = true;
    } else {
      const nick = supabaseService.getCurrentUser().data?.nickname || "ìµëª…";
      log(`ë¡œê·¸ì¸ í™•ì¸ ì™„ë£Œ. ì‘ì„±ì: ${nick}`);
    }
  } catch(e) { 
    log("ì¸ì¦ ì˜¤ë¥˜: " + e.message, true); 
  }

  setupQuill();

  // âœ… ë””ë²„ê·¸ ë²„íŠ¼
  document.getElementById("debugBtn").onclick = () => {
    window.debugQuill();
  };

  // âœ… ë“±ë¡ ë²„íŠ¼
  const postBtn = document.getElementById("postBtn");
  postBtn.onclick = async () => {
    const title = document.getElementById("postTitle").value.trim();
    const content = quill.root.innerHTML;
    
    if(!title || content === "<p><br></p>"){ 
      alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"); 
      return; 
    }
    
    postBtn.disabled = true;
    postBtn.innerText = "ë“±ë¡ ì¤‘...";
    
    // âœ… ì´ë¯¸ì§€ URL ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = content;
    const imageElements = tempDiv.querySelectorAll("img");
    const allImages = [...imageElements].map(img => img.src);
    const images = [...new Set(allImages)]; // ì¤‘ë³µ ì œê±°
    
    log(`ğŸ“ ê²Œì‹œê¸€ ë“±ë¡ ì‹œë„`);
    log(`ğŸ“Š HTMLì˜ ì´ë¯¸ì§€ ê°œìˆ˜: ${imageElements.length}ê°œ`);
    log(`ğŸ“Š ì¤‘ë³µ ì œê±° í›„: ${images.length}ê°œ`);
    
    if (allImages.length !== images.length) {
      log(`âš ï¸ ê²½ê³ : ${allImages.length - images.length}ê°œì˜ ì¤‘ë³µ ì´ë¯¸ì§€ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤`, true);
    }

    try {
      const res = await supabaseService.createPost(title, content, images);
      
      if(res.success){
        log("âœ… ë“±ë¡ ì„±ê³µ! ìƒì„¸ í˜ì´ì§€ ì´ë™");
        setTimeout(() => location.href = `post.html?id=${res.data.id}`, 800);
      } else {
        throw new Error(res.error);
      }
    } catch(e) {
      log("âŒ ë“±ë¡ ì‹¤íŒ¨: " + e.message, true);
      alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
      postBtn.disabled = false;
      postBtn.innerText = "ë“±ë¡í•˜ê¸°";
    }
  };

  // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
  document.getElementById("previewBtn").onclick = () => {
    const area = document.getElementById("previewArea");
    const content = quill.root.innerHTML;
    
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = content;
    const imageCount = tempDiv.querySelectorAll("img").length;
    
    area.style.display = "block";
    area.innerHTML = `
      <h3>[ë¯¸ë¦¬ë³´ê¸°] ${document.getElementById("postTitle").value}</h3>
      <p style="color:#666;font-size:14px;">ì´ë¯¸ì§€ ${imageCount}ê°œ í¬í•¨</p>
      <hr>
      <div class="ql-editor">${content}</div>
    `;
    area.scrollIntoView({behavior:"smooth"});
    
    log(`ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ì´ë¯¸ì§€ ${imageCount}ê°œ)`);
  };

  // ì·¨ì†Œ ë²„íŠ¼
  document.getElementById("cancelBtn").onclick = () => {
    if(confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      location.href = "index.html";
    }
  };
});
</script>
</body>
</html>
