<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ê¸€ì“°ê¸° - K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Quill ì—ë””í„° CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ“ ê¸€ì“°ê¸°</h1>

  <div class="editor-container">
    <!-- ì œëª© ì…ë ¥ -->
    <input id="postTitle" placeholder="ì œëª©" style="width:100%;padding:8px;margin-bottom:10px;">

    <!-- Quill ì—ë””í„° -->
    <div id="editor"></div>

    <!-- ë²„íŠ¼ -->
    <button id="postBtn">ë“±ë¡</button>
    <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
    <button id="cancelBtn">ì·¨ì†Œ</button>
  </div>

  <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
  <div id="previewArea" class="preview" style="display:none;"></div>

  <!-- Quill ì—ë””í„° JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://cpaikpjzlzzujwfgnanb.supabase.co";
    const supabaseKey = "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // âœ… Quill ì—ë””í„° ì´ˆê¸°í™”
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'header': [1, 2, 3, false] }],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'align': [] }],
          ['blockquote', 'code-block'],
          ['link', 'image']
        ]
      },
      placeholder: "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
    });

    // ê¸€ ë“±ë¡ ë²„íŠ¼
    document.getElementById("postBtn").onclick = async () => {
      const title = document.getElementById("postTitle").value.trim();
      const content = quill.root.innerHTML;

      if (!title || !content) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

      // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
      const { data: { user } } = await supabase.auth.getUser();

      // âœ… ë¡œê·¸ì¸ ì²´í¬
      if (!user) {
        alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•˜ì…”ì•¼ í•©ë‹ˆë‹¤");
        return;
      }

      // users í…Œì´ë¸”ì—ì„œ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
      const { data: userInfo } = await supabase
        .from("users")
        .select("nickname")
        .eq("id", user.id)
        .single();

      const nickname = userInfo?.nickname ?? user.email.split("@")[0];

      // ê¸€ ë“±ë¡
      const { data, error } = await supabase
        .from("wiki_posts")
        .insert([{
          id: crypto.randomUUID(),
          title,
          content,
          author: nickname,   // âœ… ë‹‰ë„¤ì„ ì €ì¥
          uid: user.id,       // âœ… ì‘ì„±ì UID ì €ì¥
          time: new Date().toISOString(),
          images: []
        }])
        .select();

      if (error) {
        alert("ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + error.message);
      } else {
        alert("ê¸€ì´ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
        if (data?.length) {
          location.href = `post.html?id=${data[0].id}`;
        } else {
          location.href = "index.html";
        }
      }
    };

    // ì·¨ì†Œ ë²„íŠ¼
    document.getElementById("cancelBtn").onclick = () => {
      if (confirm("ì‘ì„± ì¤‘ì¸ ê¸€ì„ ì·¨ì†Œí•˜ê³  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        location.href = "index.html";
      }
    };

    // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
    document.getElementById("previewBtn").onclick = () => {
      const title = document.getElementById("postTitle").value.trim();
      const content = quill.root.innerHTML;

      const previewArea = document.getElementById("previewArea");
      previewArea.style.display = "block";
      previewArea.innerHTML = `
        <h3>${title || "(ì œëª© ì—†ìŒ)"}</h3>
        <div>${content || "(ë‚´ìš© ì—†ìŒ)"}</div>
      `;
    };
  </script>
</body>
</html>
