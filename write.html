<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„± - K-ReptileWiki</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family:'Apple SD Gothic Neo','Malgun Gothic',sans-serif; background:#f9fafb; margin:0; }
.container { max-width:900px; margin:0 auto; padding:20px; }
.editor-container { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
#editor { height:420px; }
input#postTitle { width:100%; padding:14px; margin-bottom:15px; border:1px solid #ddd; border-radius:6px; font-size:18px; }

.btn-group { margin-top:20px; display:flex; gap:10px; }
button { padding:12px 22px; border:none; border-radius:6px; font-weight:bold; color:white; cursor:pointer; }
#postBtn { background:#2563eb; }
#postBtn:disabled { background:#94a3b8; }
#previewBtn { background:#10b981; }
#cancelBtn { background:#6b7280; }

#postStatus { white-space:pre-line; margin-top:15px; font-size:13px; color:#334155; }

/* ì—…ë¡œë“œ ì˜¤ë²„ë ˆì´ */
.upload-overlay {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  z-index:9999;
  justify-content:center;
  align-items:center;
}
.upload-overlay.active { display:flex; }
.upload-progress {
  background:#fff;
  padding:30px 40px;
  border-radius:10px;
  text-align:center;
  min-width:320px;
}
.spinner {
  border:4px solid #f3f3f3;
  border-top:4px solid #2563eb;
  border-radius:50%;
  width:50px;
  height:50px;
  animation:spin .8s linear infinite;
  margin:0 auto 20px;
}
@keyframes spin {
  to { transform:rotate(360deg); }
}

/* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì € */
#image-resizer {
  display:none;
  position:absolute;
  z-index:1000;
  background:white;
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
}
</style>
</head>

<body>

<div id="uploadOverlay" class="upload-overlay">
  <div class="upload-progress">
    <div class="spinner"></div>
    <div id="progressText"><b>ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</b></div>
    <div id="progressDetail">ì›ë³¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
  </div>
</div>

<div id="image-resizer">
  <b style="font-size:12px;">ì´ë¯¸ì§€ ë„ˆë¹„</b><br>
  <input type="range" id="sizeSlider" min="50" max="800" step="10">
  <div id="sizeValue" style="font-size:12px;text-align:center;">300px</div>
</div>

<div class="container">
  <h1>ğŸ“ ìƒˆ ë¬¸ì„œ ì‘ì„±</h1>

  <div class="editor-container">
    <input id="postTitle" placeholder="ë¬¸ì„œ ì œëª©">
    <div id="editor"></div>

    <div class="btn-group">
      <button id="postBtn">ë“±ë¡í•˜ê¸°</button>
      <button id="previewBtn">ë¯¸ë¦¬ë³´ê¸°</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>

    <div id="postStatus">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
  </div>

  <div id="previewArea" style="display:none;margin-top:30px;background:white;padding:20px;border-radius:10px;"></div>
</div>

<script type="module">
/* =========================
   Supabase ì„¤ì •
========================= */
const SUPABASE_URL = "https://cpaikpjzlzzujwfgnanb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwYWlrcGp6bHp6dWp3ZmduYW5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNDEwMzIsImV4cCI6MjA4MTcxNzAzMn0.u5diz_-p8Hh1FtkVO1CsDSUbz9fbSN2zXAIIP2637sc";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const statusEl = document.getElementById("postStatus");
const overlay = document.getElementById("uploadOverlay");
const progressDetail = document.getElementById("progressDetail");

let quill;
let isUploading = false;

/* =========================
   ë¡œê·¸
========================= */
function log(msg){
  statusEl.innerText += `\n${msg}`;
  console.log(msg);
}

/* =========================
   Quill
========================= */
quill = new Quill("#editor", {
  theme:"snow",
  placeholder:"ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”",
  modules:{
    toolbar:{
      container:[
        [{header:[1,2,3,false]}],
        ["bold","italic","underline"],
        ["link","image"],
        ["clean"]
      ],
      handlers:{
        image: handleImageUpload
      }
    }
  }
});

/* =========================
   ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì••ì¶• âŒ)
========================= */
async function handleImageUpload(){
  if(isUploading) return alert("ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤");

  const { data:{ user } } = await supabase.auth.getUser();
  if(!user) return alert("ë¡œê·¸ì¸ í•„ìš”");

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";

  input.onchange = async () => {
    const file = input.files[0];
    if(!file) return;

    isUploading = true;
    overlay.classList.add("active");
    progressDetail.innerText = `ì›ë³¸ í¬ê¸°: ${(file.size/1024).toFixed(1)}KB`;

    try{
      const ext = file.name.split(".").pop();
      const path = `${user.id}/${Date.now()}.${ext}`;

      const { error } = await supabase.storage
        .from("image")
        .upload(path, file);

      if(error) throw error;

      const { data } = supabase.storage
        .from("image")
        .getPublicUrl(path);

      const range = quill.getSelection(true);
      quill.insertEmbed(range.index, "image", data.publicUrl);
      quill.setSelection(range.index + 1);

      log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ");

    }catch(e){
      alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
      log(e.message);
    }finally{
      overlay.classList.remove("active");
      isUploading = false;
    }
  };

  input.click();
}

/* =========================
   ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì €
========================= */
const resizer = document.getElementById("image-resizer");
const slider = document.getElementById("sizeSlider");
const sizeValue = document.getElementById("sizeValue");
let targetImg = null;

quill.root.addEventListener("click", e=>{
  if(e.target.tagName === "IMG"){
    targetImg = e.target;
    resizer.style.display = "block";
    slider.value = targetImg.width || 300;
    sizeValue.innerText = slider.value + "px";
  }else{
    resizer.style.display = "none";
  }
});

slider.oninput = e=>{
  if(targetImg){
    targetImg.style.width = e.target.value + "px";
    sizeValue.innerText = e.target.value + "px";
  }
};

/* =========================
   ë²„íŠ¼
========================= */
document.getElementById("cancelBtn").onclick = () => location.href="index.html";

document.getElementById("previewBtn").onclick = () => {
  const area = document.getElementById("previewArea");
  area.style.display="block";
  area.innerHTML = `<h3>${postTitle.value}</h3><hr>${quill.root.innerHTML}`;
};
</script>

</body>
</html>
