<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>K-ReptileWiki ì™„ì „íŒ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:0;}
.container { max-width:800px; margin:50px auto; padding:30px; background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
h1,h2,h3 { margin:0 0 10px 0;}
h1 { text-align:center; color:#2563eb;}
form { display:flex; flex-direction:column; margin-bottom:20px; }
.form-group { margin-bottom:10px; }
.form-group label { font-weight:bold; display:block; margin-bottom:5px; }
.form-group input, .form-group textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box; }
.form-group textarea { resize:vertical; height:60px; }
.btn { padding:8px 12px; margin:5px 0; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.btn-primary { background:#2563eb; color:white; }
.btn-success { background:#10b981; color:white; }
.btn-secondary { background:#6b7280; color:white; }
.btn-danger { background:#f87171; color:white; }
.btn-warning { background:#fbbf24; color:white; }
.btn:disabled { background:#ccc; cursor:not-allowed; }
.user-info { padding:15px; background:#f3f4f6; border-radius:6px; margin-bottom:15px; text-align:center; }
.post { padding:15px; border-bottom:1px solid #ddd; margin-bottom:10px; }
.post h3 { margin-bottom:5px; }
.comments { margin-top:10px; padding-left:15px; }
.comment { margin-bottom:5px; border-bottom:1px dashed #ccc; padding-bottom:3px; }
.hidden { display:none; }
.deleted { opacity:0.6; }
.version { font-size:0.85em; color:#555; margin-top:5px; }
.version-btn { font-size:0.75em; margin-left:3px; padding:2px 4px; }
</style>
</head>
<body>
<div class="container">
<h1>ğŸ¦ K-ReptileWiki ì™„ì „íŒ</h1>

<div id="userInfo" class="user-info">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</div>

<form id="loginForm">
<div class="form-group">
<label>ì´ë©”ì¼</label>
<input type="email" id="email" placeholder="example@email.com">
</div>
<div class="form-group">
<label>ë¹„ë°€ë²ˆí˜¸</label>
<input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
</div>
<div id="signupFields" class="hidden">
<div class="form-group">
<label>ë‹‰ë„¤ì„ (ì„ íƒ)</label>
<input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ (ë¹„ì›Œë‘ë©´ ì´ë©”ì¼ ì‚¬ìš©)">
</div>
<div class="form-group">
<label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
<input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
</div>
</div>

<button type="button" id="loginBtn" class="btn btn-primary">ë¡œê·¸ì¸</button>
<button type="button" id="signupBtn" class="btn btn-success hidden">íšŒì›ê°€ì…</button>
<button type="button" id="toggleBtn" class="btn btn-secondary">íšŒì›ê°€ì… ëª¨ë“œë¡œ ì „í™˜</button>
</form>

<div id="logoutSection" class="hidden">
<button id="logoutBtn" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div id="postFormContainer" class="hidden">
<h2>ê²Œì‹œê¸€ ì‘ì„±</h2>
<form id="postForm">
<div class="form-group">
<label>ì œëª©</label>
<input type="text" id="postTitle" placeholder="ì œëª©">
</div>
<div class="form-group">
<label>ë‚´ìš©</label>
<textarea id="postContent" placeholder="ë‚´ìš©"></textarea>
</div>
<button type="button" id="createPostBtn" class="btn btn-primary">ì‘ì„±</button>
</form>
</div>

<div id="postsContainer" class="hidden">
<h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
<div id="posts"></div>
</div>
</div>

<script type="module">
import { supabaseService } from "./js/supabase.js";

const userInfoDiv = document.getElementById("userInfo");
const loginForm = document.getElementById("loginForm");
const logoutSection = document.getElementById("logoutSection");
const signupFields = document.getElementById("signupFields");
const toggleBtn = document.getElementById("toggleBtn");
const postsContainer = document.getElementById("postsContainer");
const postsDiv = document.getElementById("posts");
const postFormContainer = document.getElementById("postFormContainer");
let isSignupMode = false;

function updateUI(){
  const {user,data} = supabaseService.getCurrentUser();
  if(user){
    const nickname = data?.nickname||user.email.split("@")[0];
    const role = data?.role||"user";
    userInfoDiv.innerHTML = `í˜„ì¬ ë¡œê·¸ì¸: <strong>${nickname}</strong><br>ê¶Œí•œ: ${role==="admin"?"ê´€ë¦¬ì":"ì¼ë°˜ ì‚¬ìš©ì"}`;
    loginForm.classList.add("hidden");
    logoutSection.classList.remove("hidden");
    postsContainer.classList.remove("hidden");
    postFormContainer.classList.remove("hidden");
    loadPosts();
  }else{
    userInfoDiv.textContent="ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ";
    loginForm.classList.remove("hidden");
    logoutSection.classList.add("hidden");
    postsContainer.classList.add("hidden");
    postFormContainer.classList.add("hidden");
  }
}

async function loadPosts(){
  postsDiv.innerHTML="ë¡œë”© ì¤‘...";
  const result = await supabaseService.getPosts(true);
  if(result.success){
    postsDiv.innerHTML="";
    for(const post of result.data){
      const div = document.createElement("div");
      div.className="post"+(post.deleted?" deleted":"");
      div.innerHTML=`<h3>${post.title}</h3><p>${post.content}</p>
      <button class="btn btn-secondary likeBtn" data-id="${post.id}">ì¢‹ì•„ìš”</button>
      <span class="likeCount" id="like-${post.id}">0</span>
      <div class="comments" id="comments-${post.id}"></div>
      <form class="commentForm" data-id="${post.id}">
      <input type="text" placeholder="ëŒ“ê¸€ ì…ë ¥" class="commentInput">
      <button type="button" class="btn btn-primary commentSubmit">ëŒ“ê¸€</button>
      </form>
      <div class="version" id="versions-${post.id}"></div>
      `;
      postsDiv.appendChild(div);

      await updateLikeCount(post.id);
      await loadComments(post.id);
      await loadVersions(post.id);

      // ì¢‹ì•„ìš”
      div.querySelector(".likeBtn").addEventListener("click", async()=>{
        await supabaseService.toggleLike(post.id);
        await updateLikeCount(post.id);
      });

      // ëŒ“ê¸€
      div.querySelector(".commentSubmit").addEventListener("click", async(e)=>{
        const input = div.querySelector(".commentInput");
        const content = input.value.trim();
        if(!content) return;
        await supabaseService.addComment(post.id, content);
        input.value="";
        await loadComments(post.id);
      });

      // ê´€ë¦¬ì ê¸°ëŠ¥
      if(supabaseService.isAdmin()){
        const adminDiv = document.createElement("div");
        adminDiv.style.marginTop="5px";
        adminDiv.innerHTML=post.deleted
          ? `<button class="btn btn-warning restorePostBtn" data-id="${post.id}">ë³µì›</button>`
          : `<button class="btn btn-danger deletePostBtn" data-id="${post.id}">ì‚­ì œ</button>
             <button class="btn btn-success editPostBtn" data-id="${post.id}">ìˆ˜ì •</button>`;
        div.appendChild(adminDiv);

        adminDiv.querySelector(".deletePostBtn")?.addEventListener("click", async()=>{
          await supabaseService.deletePost(post.id); loadPosts();
        });
        adminDiv.querySelector(".restorePostBtn")?.addEventListener("click", async()=>{
          await supabaseService.restorePost(post.id); loadPosts();
        });
        adminDiv.querySelector(".editPostBtn")?.addEventListener("click", async()=>{
          const newTitle = prompt("ìƒˆ ì œëª©:", post.title);
          const newContent = prompt("ìƒˆ ë‚´ìš©:", post.content);
          if(newTitle && newContent){
            await supabaseService.updatePost(post.id,newTitle,newContent);
            loadPosts();
          }
        });
      }
    }
  }else postsDiv.textContent="ê²Œì‹œê¸€ ë¡œë”© ì‹¤íŒ¨: "+result.error;
}

async function loadComments(postId){
  const commentsDiv = document.getElementById("comments-"+postId);
  const res = await supabaseService.getComments(postId);
  if(res.success){
    commentsDiv.innerHTML="";
    res.data.forEach(c=>{
      const div=document.createElement("div");
      div.className="comment";
      div.textContent=`${c.author}: ${c.content}`;
      if(supabaseService.isAdmin()){
        const delBtn = document.createElement("button");
        delBtn.className="btn btn-danger btn-sm";
        delBtn.style.marginLeft="5px";
        delBtn.textContent="ì‚­ì œ";
        delBtn.addEventListener("click", async()=>{
          await supabaseService.deleteComment(c.id);
          loadComments(postId);
        });
        div.appendChild(delBtn);
      }
      commentsDiv.appendChild(div);
    });
  }
}

async function updateLikeCount(postId){
  const count = await supabaseService.getLikeCount(postId);
  const span = document.getElementById("like-"+postId);
  span.textContent=count;
}

// ê²Œì‹œê¸€ ë²„ì „ ê´€ë¦¬
async function loadVersions(postId){
  const versionDiv = document.getElementById("versions-"+postId);
  const {data,error} = await supabaseService.client
    .from("wiki_posts_versions")
    .select("*")
    .eq("post_id",postId)
    .order("updated_at",{ascending:false});
  if(!error && data.length){
    versionDiv.innerHTML="ë²„ì „: ";
    data.forEach(v=>{
      const btn = document.createElement("button");
      btn.className="btn btn-secondary version-btn";
      btn.textContent=v.updated_at.split("T")[0];
      btn.addEventListener("click", async()=>{
        if(confirm("ì´ ë²„ì „ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
          await supabaseService.updatePost(postId,v.title,v.content);
          loadPosts();
        }
      });
      versionDiv.appendChild(btn);
    });
  }
}

// ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
window.addEventListener("load", async()=>{
  try{
    await supabaseService.waitForAuth();
    const {data} = await supabaseService.client.auth.getSession();
    if(data?.session?.user) await supabaseService._setUser(data.session.user);
  }catch(e){ console.error(e); }
  updateUI();
});

// ë¡œê·¸ì¸/íšŒì›ê°€ì… í† ê¸€
toggleBtn.addEventListener("click", ()=>{
  isSignupMode=!isSignupMode;
  signupFields.classList.toggle("hidden",!isSignupMode);
  toggleBtn.textContent = isSignupMode?"ë¡œê·¸ì¸ ëª¨ë“œë¡œ ì „í™˜":"íšŒì›ê°€ì… ëª¨ë“œë¡œ ì „í™˜";
  document.getElementById("loginBtn").classList.toggle("hidden",isSignupMode);
  document.getElementById("signupBtn").classList.toggle("hidden",!isSignupMode);
});

// ë¡œê·¸ì¸
document.getElementById("loginBtn").addEventListener("click", async()=>{
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!email||!password){ alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
  const res = await supabaseService.signIn(email,password);
  if(res.success){ alert("ë¡œê·¸ì¸ ì„±ê³µ"); await supabaseService.waitForAuth(); updateUI();}
  else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+res.error);
});

// íšŒì›ê°€ì…
document.getElementById("signupBtn").addEventListener("click", async()=>{
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const confirmPassword = document.getElementById("confirmPassword").value.trim();
  const nickname = document.getElementById("nickname").value.trim();
  if(!email||!password){ alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
  if(password!==confirmPassword){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"); return; }
  const res = await supabaseService.signUp(email,password,nickname);
  if(res.success){ alert("íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); location.reload();}
  else alert("íšŒì›ê°€ì… ì‹¤íŒ¨: "+res.error);
});

// ë¡œê·¸ì•„ì›ƒ
document.getElementById("logoutBtn").addEventListener("click", async()=>{
  const res = await supabaseService.signOut();
  if(res.success){ alert("ë¡œê·¸ì•„ì›ƒë¨"); updateUI();}
});

// ê²Œì‹œê¸€ ì‘ì„±
document.getElementById("createPostBtn").addEventListener("click", async()=>{
  const title=document.getElementById("postTitle").value.trim();
  const content=document.getElementById("postContent").value.trim();
  if(!title||!content){ alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"); return;}
  const res = await supabaseService.createPost(title,content);
  if(res.success){ document.getElementById("postTitle").value=""; document.getElementById("postContent").value=""; loadPosts();}
  else alert("ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨: "+res.error);
});
</script>
</body>
</html>
