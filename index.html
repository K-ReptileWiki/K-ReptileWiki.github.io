<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #searchResults div, #postList div {
      border:1px solid #ddd; padding:10px; margin:5px 0; border-radius:6px;
    }
    button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; }
    button:hover { background:#1e40af; }
    a { text-decoration:none; color:#2563eb; }
    a:hover { text-decoration:underline; }
  </style>
</head>

<body>
  <h1>ğŸ¦ K-ReptileWiki</h1>

  <hr>
  <!-- ğŸ” ê²€ìƒ‰ -->
  <input id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
  <button id="searchBtn">ê²€ìƒ‰</button>
  <div id="searchResults"></div>
  <hr>

  <!-- ğŸ“š ì¢… ë§í¬ -->
  <a href="/species/crested_gecko.html">í¬ë ˆìŠ¤í‹°ë“œ ê²Œì½”</a><br>
  <a href="/species/day_gecko.html">ë°ì´ê²Œì½”</a><br>
  <a href="/species/leopard_gecko.html">ë ˆì˜¤íŒŒë“œ ê²Œì½”</a>
  <hr>

  <!-- ğŸ“ ê¸€ì“°ê¸° ë²„íŠ¼ -->
  <button id="writeBtn">ğŸ“ ê¸€ì“°ê¸°</button>

  <hr>
  <!-- ğŸ“‘ ê¸€ ëª©ë¡ -->
  <h2>ìµœì‹  ê¸€</h2>
  <div id="postList"></div>

  <!-- âœ… Firestore ì—°ê²° -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyDfrvgcAed9VvS5MFXVZFIxch8aCAfMp1w",
      authDomain: "k-reptilewiki-1f09f.firebaseapp.com",
      projectId: "k-reptilewiki-1f09f"
    });
    const db = getFirestore(app);

    // âœ… ê¸€ ëª©ë¡ ì‹¤ì‹œê°„ í‘œì‹œ
    const postsRef = collection(db, "wiki_posts");
    onSnapshot(postsRef, snap => {
      const list = document.getElementById("postList");
      list.innerHTML = "";
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");

        let imgHtml = "";
        if (data.images && Array.isArray(data.images)) {
          imgHtml = data.images.map(url => `<img src="${url}" style="max-width:200px;margin:5px;">`).join("");
        }

        // ê¸€ ì œëª©ì— ë§í¬ ì¶”ê°€ (post.html?id=ë¬¸ì„œID)
        div.innerHTML = `
          <h3><a href="/post.html?id=${docSnap.id}">${data.title}</a></h3>
          <p>${data.content}</p>
          ${imgHtml}
          <small>ì‘ì„±ì: ${data.author ?? "ìµëª…"} | ${data.time?.toDate?.().toLocaleString()}</small>
        `;
        list.appendChild(div);
      });
    });

    // ğŸ” ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById("searchBtn").addEventListener("click", async () => {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      if (!keyword) return;

      const snap = await getDocs(postsRef);
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const title = data.title?.toLowerCase() ?? "";

        if (title.includes(keyword)) {
          const div = document.createElement("div");
          div.innerHTML = `
            <h3><a href="/post.html?id=${docSnap.id}">${data.title}</a></h3>
            <p>${data.content}</p>
            <small>ì‘ì„±ì: ${data.author ?? "ìµëª…"} | ${data.time?.toDate?.().toLocaleString()}</small>
          `;
          resultsDiv.appendChild(div);
        }
      });

      if (!resultsDiv.innerHTML) {
        resultsDiv.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
      }
    });

    // ğŸ“ ê¸€ì“°ê¸° ë²„íŠ¼
    document.getElementById("writeBtn").addEventListener("click", () => {
      if (confirm("ê¸€ì“°ê¸° í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) {
        location.href = "/posts.html";
      }
    });
  </script>
</body>
</html>
