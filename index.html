<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:0; }
    header { background:#2563eb; color:white; padding:15px; text-align:center; position:relative; }
    nav { margin:15px; }
    nav a { display:block; margin:5px 0; color:#2563eb; text-decoration:none; }
    nav a:hover { text-decoration:underline; }
    .post-card {
      background:#fff;
      padding:15px;
      margin-bottom:15px;
      border-radius:8px;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    .post-card img { max-width:200px; border-radius:6px; margin-top:8px; }
    #userInfo { position:absolute; right:20px; top:15px; font-size:14px; }
    .btn { margin:10px; padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    .btn-primary { background:#10b981; color:white; }
    .btn-danger { background:#f87171; color:white; }
    .search-box { margin:15px; padding:15px; background:white; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
    .search-box input { width:calc(100% - 100px); padding:8px; border:1px solid #ddd; border-radius:4px; }
    .search-box button { padding:8px 16px; margin-left:5px; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ¦ K-ReptileWiki</h1>
    <div id="userInfo">ë¡œë”© ì¤‘...</div>
  </header>

  <nav>
    <a href="write.html" id="writeLink">âœï¸ ê¸€ì“°ê¸°</a>
    <a href="index.html">ğŸ  ë©”ì¸</a>
    <a href="species/crested_gecko.html">í¬ë ˆìŠ¤í‹°ë“œ ê²Œì½”</a>
    <a href="species/leopard_gecko.html">ë ˆì˜¤íŒŒë“œ ê²Œì½”</a>
  </nav>

  <!-- ê²€ìƒ‰ -->
  <div class="search-box">
    <input id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
    <button id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
  </div>

  <!-- ê¸€ ëª©ë¡ -->
  <div style="margin:15px;">
    <h2>ìµœì‹  ê¸€</h2>
    <div id="postList">ë¡œë”© ì¤‘...</div>
  </div>

  <div id="searchResults" style="margin:15px;"></div>

  <script type="module">
    import { supabaseService } from "./js/supabase.js";

    document.addEventListener("DOMContentLoaded", async () => {

      // ------------------------
      // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
      // ------------------------
      async function updateUserInfo() {
        const { user, profile } = supabaseService.getCurrentUser();
        const userInfoDiv = document.getElementById("userInfo");
        const writeLink = document.getElementById("writeLink");

        if (user) {
          const nickname = profile?.nickname || user.email.split("@")[0];
          const isAdmin = profile?.role === "admin" || profile?.role === "owner";
          
          userInfoDiv.innerHTML = `
            ${nickname}ë‹˜
            <button id="logoutBtn" class="btn btn-danger" style="margin-left:10px;padding:4px 8px;">ë¡œê·¸ì•„ì›ƒ</button>
            ${isAdmin ? '<button id="adminBtn" class="btn" style="background:#10b981;color:white;padding:4px 8px;margin-left:5px;">ê´€ë¦¬ì</button>' : ''}
          `;

          document.getElementById("logoutBtn").addEventListener("click", async () => {
            await supabaseService.signOut();
            location.reload();
          });

          const adminBtn = document.getElementById("adminBtn");
          if (adminBtn) {
            adminBtn.addEventListener("click", () => location.href="admin.html");
          }

          if (writeLink) writeLink.style.display="block";

        } else {
          userInfoDiv.innerHTML = `<button id="loginBtn" class="btn btn-primary">ë¡œê·¸ì¸</button>`;
          document.getElementById("loginBtn")?.addEventListener("click", () => location.href="login.html");
          if (writeLink) writeLink.style.display="none";
        }
      }

      // ------------------------
      // ê¸€ ëª©ë¡ ë¡œë“œ
      // ------------------------
      async function loadPosts() {
        const listDiv = document.getElementById("postList");
        const result = await supabaseService.getPosts(true); // ì‚­ì œê¸€ í¬í•¨

        if (!result.success) {
          listDiv.textContent = "ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + result.error;
          return;
        }

        if (!result.data || result.data.length === 0) {
          listDiv.textContent = "ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        listDiv.innerHTML = "";

        result.data.forEach(post => {
          const div = document.createElement("div");
          div.className = "post-card";

          if (post.deleted) {
            div.innerHTML = `
              <h3>ì‚­ì œëœ ê¸€</h3>
              <p style="color:#888;">ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.</p>
            `;
            listDiv.appendChild(div);
            return;
          }

          const plainText = post.content?.replace(/<[^>]+>/g, "") ?? "";
          const shortText = plainText.length > 100 ? plainText.substring(0, 100) + "..." : plainText;

          let imgHtml = "";
          if (post.images && Array.isArray(post.images) && post.images.length > 0) {
            imgHtml = post.images.slice(0, 3).map(url => `<img src="${url}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">`).join("");
          }

          div.innerHTML = `
            <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
            <p>${shortText}</p>
            ${imgHtml}
            <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
          `;
          listDiv.appendChild(div);
        });
      }

      // ------------------------
      // ê²€ìƒ‰
      // ------------------------
      async function searchPosts() {
        const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
        const resultsDiv = document.getElementById("searchResults");
        resultsDiv.innerHTML = "";

        if (!keyword) {
          alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          return;
        }

        const result = await supabaseService.getPosts();
        if (!result.success) {
          resultsDiv.textContent = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + result.error;
          return;
        }

        const matched = result.data.filter(post => {
          const title = post.title?.toLowerCase() ?? "";
          const content = post.content?.toLowerCase() ?? "";
          return title.includes(keyword) || content.includes(keyword);
        });

        if (matched.length === 0) {
          resultsDiv.innerHTML = "<h3>ê²€ìƒ‰ ê²°ê³¼</h3><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        resultsDiv.innerHTML = `<h3>ê²€ìƒ‰ ê²°ê³¼ (${matched.length}ê°œ)</h3>`;
        matched.forEach(post => {
          const plainText = post.content?.replace(/<[^>]+>/g, "") ?? "";
          const shortText = plainText.length > 100 ? plainText.substring(0, 100) + "..." : plainText;

          const div = document.createElement("div");
          div.className = "post-card";
          div.innerHTML = `
            <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
            <p>${shortText}</p>
            <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
          `;
          resultsDiv.appendChild(div);
        });
      }

      // ------------------------
      // ì´ë²¤íŠ¸ ì—°ê²°
      // ------------------------
      document.getElementById("searchBtn")?.addEventListener("click", searchPosts);

      // ------------------------
      // ì´ˆê¸°í™”
      // ------------------------
      await supabaseService.waitForAuth(); // ì¸ì¦ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
      await updateUserInfo();              // ë¡œê·¸ì¸ ìƒíƒœ UI ê°±ì‹ 
      await loadPosts();                   // ê¸€ ëª©ë¡ ë¡œë”©
    });
  </script>
</body>
</html>
