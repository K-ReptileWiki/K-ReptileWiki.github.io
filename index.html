<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- âœ… ì™¸ë¶€ CSS íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° -->
  <link rel="stylesheet" href="style.css">
</head>


<body>
  <h1>ğŸ¦ K-ReptileWiki</h1>

  <hr>
  <!-- ğŸ” ê²€ìƒ‰ -->
  <input id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
  <button id="searchBtn">ê²€ìƒ‰</button>
  <div id="searchResults"></div>
  <hr>

  <!-- ğŸ“š ì¢… ë§í¬ -->
  <a href="species/crested_gecko.html">í¬ë ˆìŠ¤í‹°ë“œ ê²Œì½”</a><br>
  <a href="species/day_gecko.html">ë°ì´ê²Œì½”</a><br>
  <a href="species/leopard_gecko.html">ë ˆì˜¤íŒŒë“œ ê²Œì½”</a>
  <hr>

  <!-- ğŸ“ ê¸€ì“°ê¸° ë²„íŠ¼ -->
  <button id="writeBtn">ğŸ“ ê¸€ì“°ê¸°</button>

  <hr>
  <!-- ğŸ“‘ ê¸€ ëª©ë¡ -->
  <h2>ìµœì‹  ê¸€</h2>
  <div id="postList"></div>

  <!-- âœ… Supabase ì—°ê²° -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ğŸ”‘ Supabase ì´ˆê¸°í™”
    const supabaseUrl = "https://cpaikpjzlzzujwfgnanb.supabase.co";
    const supabaseKey = "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // âœ… ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPosts() {
      const { data, error } = await supabase
        .from("wiki_posts") // Supabase í…Œì´ë¸” ì´ë¦„
        .select("*")
        .order("time", { ascending: false });

      const list = document.getElementById("postList");
      list.innerHTML = "";

      if (error) {
        console.error("ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error.message);
        return;
      }

      data.forEach(post => {
        let imgHtml = "";
        if (post.images && Array.isArray(post.images)) {
          imgHtml = post.images.map(url => `<img src="${url}">`).join("");
        }

        const plainText = post.content.replace(/<[^>]+>/g, "");
        const shortText = plainText.length > 100 ? plainText.substring(0, 100) + "..." : plainText;

        const div = document.createElement("div");
        div.innerHTML = `
          <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
          <p>${shortText}</p>
          ${imgHtml}
          <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
        `;
        list.appendChild(div);
      });
    }

    // ğŸ” ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById("searchBtn").addEventListener("click", async () => {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      if (!keyword) return;

      const { data, error } = await supabase
        .from("wiki_posts")
        .select("*");

      if (error) {
        console.error("ê²€ìƒ‰ ì‹¤íŒ¨:", error.message);
        return;
      }

      data.forEach(post => {
        const title = post.title?.toLowerCase() ?? "";
        const content = post.content?.toLowerCase() ?? "";

        if (title.includes(keyword) || content.includes(keyword)) {
          const plainText = post.content.replace(/<[^>]+>/g, "");
          const shortText = plainText.length > 100 ? plainText.substring(0, 100) + "..." : plainText;

          const div = document.createElement("div");
          div.innerHTML = `
            <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
            <p>${shortText}</p>
            <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
          `;
          resultsDiv.appendChild(div);
        }
      });

      if (!resultsDiv.innerHTML) {
        resultsDiv.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
      }
    });

    // ğŸ“ ê¸€ì“°ê¸° ë²„íŠ¼
    document.getElementById("writeBtn").addEventListener("click", () => {
      location.href = "posts.html";
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadPosts();
  </script>
</body>
</html>
