<script type="module">
import { supabaseService } from "./js/supabase.js";

// ----------------------------
// ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
// ----------------------------
async function updateUserInfo() {
  const userInfoDiv = document.getElementById("userInfo");
  const { user, profile } = supabaseService.getCurrentUser();

  if (user) {
    const nickname = profile?.nickname || user.email.split("@")[0];
    userInfoDiv.innerHTML = `
      ${nickname}ë‹˜
      <button id="logoutBtn" class="btn btn-danger" style="margin-left:10px;padding:4px 8px;">ë¡œê·¸ì•„ì›ƒ</button>
      ${profile?.role === "admin" ? '<button id="adminBtn" class="btn btn-danger" style="padding:4px 8px;">ê´€ë¦¬ì</button>' : ''}
    `;

    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      const result = await supabaseService.signOut();
      if (result.success) location.reload();
    });

    document.getElementById("adminBtn")?.addEventListener("click", () => {
      location.href = "admin.html";
    });

  } else {
    userInfoDiv.innerHTML = `<button id="loginBtn" class="btn btn-primary">ë¡œê·¸ì¸</button>`;
    document.getElementById("loginBtn")?.addEventListener("click", () => {
      location.href = "login.html";
    });
  }
}

// ----------------------------
// ê¸€ ëª©ë¡ ë¡œë“œ
// ----------------------------
async function loadPosts() {
  const listDiv = document.getElementById("postList");
  const result = await supabaseService.getPosts(true); // ì‚­ì œê¸€ë„ í¬í•¨

  if (!result.success) {
    listDiv.textContent = "ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + result.error;
    return;
  }

  if (!result.data || result.data.length === 0) {
    listDiv.textContent = "ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  listDiv.innerHTML = "";

  result.data.forEach(post => {
    const div = document.createElement("div");
    div.className = "post-card";

    if (post.deleted) {
      div.innerHTML = `
        <h3>ì‚­ì œëœ ê¸€</h3>
        <p style="color:#888;">ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.</p>
      `;
      listDiv.appendChild(div);
      return;
    }

    const plainText = post.content?.replace(/<[^>]+>/g, "") ?? "";
    const shortText = plainText.length > 100 ? plainText.substring(0,100) + "..." : plainText;

    let imgHtml = "";
    if (post.images && Array.isArray(post.images) && post.images.length > 0) {
      imgHtml = post.images.slice(0,3).map(url => `<img src="${url}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">`).join("");
    }

    div.innerHTML = `
      <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
      <p>${shortText}</p>
      ${imgHtml}
      <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
    `;
    listDiv.appendChild(div);
  });
}

// ----------------------------
// ê²€ìƒ‰ ê¸°ëŠ¥
// ----------------------------
async function searchPosts() {
  const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = "";

  if (!keyword) {
    alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const result = await supabaseService.getPosts();
  if (!result.success) {
    resultsDiv.textContent = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + result.error;
    return;
  }

  const matched = result.data.filter(post => {
    const title = post.title?.toLowerCase() ?? "";
    const content = post.content?.toLowerCase() ?? "";
    return title.includes(keyword) || content.includes(keyword);
  });

  if (matched.length === 0) {
    resultsDiv.innerHTML = "<h3>ê²€ìƒ‰ ê²°ê³¼</h3><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  resultsDiv.innerHTML = `<h3>ê²€ìƒ‰ ê²°ê³¼ (${matched.length}ê°œ)</h3>`;
  matched.forEach(post => {
    const plainText = post.content?.replace(/<[^>]+>/g,"") ?? "";
    const shortText = plainText.length > 100 ? plainText.substring(0,100) + "..." : plainText;

    const div = document.createElement("div");
    div.className = "post-card";
    div.innerHTML = `
      <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
      <p>${shortText}</p>
      <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
    `;
    resultsDiv.appendChild(div);
  });
}

document.getElementById("searchBtn").addEventListener("click", searchPosts);

// ----------------------------
// ì´ˆê¸°í™”
// ----------------------------
async function init() {
  // ğŸ”‘ ì¸ì¦ ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  await supabaseService.waitForAuth();

  // UI ê°±ì‹ 
  await updateUserInfo();

  // ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  await loadPosts();
}

init();
</script>
