<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-ReptileWiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ì™¸ë¶€ CSS -->
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:0; }
    header { background:#2563eb; color:white; padding:15px; text-align:center; }
    nav { margin:15px; }
    nav a { display:block; margin:5px 0; color:#2563eb; text-decoration:none; }
    nav a:hover { text-decoration:underline; }
    .post-card {
      background:#fff;
      padding:15px;
      margin-bottom:15px;
      border-radius:8px;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    .post-card img {
      max-width:200px;
      border-radius:6px;
      margin-top:8px;
    }
    .post-card h3 a {
      color:#2563eb;
      text-decoration:none;
    }
    .post-card h3 a:hover {
      text-decoration:underline;
    }
    #adminBtn {
      margin:10px; padding:8px 14px;
      background:#f87171; color:white;
      border:none; border-radius:6px;
      cursor:pointer; font-weight:bold;
    }
  </style>
</head>

<body>
  <header>
    <h1>ğŸ¦ K-ReptileWiki</h1>
    <div id="userInfo">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</div>
    <button id="adminBtn">ê´€ë¦¬ì í˜ì´ì§€</button>
  </header>

  <hr>
  <!-- ğŸ” ê²€ìƒ‰ -->
  <input id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
  <button id="searchBtn">ê²€ìƒ‰</button>
  <div id="searchResults"></div>
  <hr>

  <!-- ğŸ“š ì¢… ë§í¬ -->
  <nav>
    <a href="species/crested_gecko.html">í¬ë ˆìŠ¤í‹°ë“œ ê²Œì½”</a>
    <a href="species/day_gecko.html">ë°ì´ê²Œì½”</a>
    <a href="species/leopard_gecko.html">ë ˆì˜¤íŒŒë“œ ê²Œì½”</a>
  </nav>
  <hr>

  <!-- ğŸ“ ê¸€ì“°ê¸° ë²„íŠ¼ -->
  <button id="writeBtn">ğŸ“ ê¸€ì“°ê¸°</button>

  <hr>
  <!-- ğŸ“‘ ê¸€ ëª©ë¡ -->
  <h2>ìµœì‹  ê¸€</h2>
  <div id="postList"></div>

  <!-- âœ… Supabase ì—°ê²° -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Supabase ì´ˆê¸°í™”
    const supabaseUrl = "https://cpaikpjzlzzujwfgnanb.supabase.co";
    const supabaseKey = "sb_publishable_-dZ6xDssPQs29A_hHa2Irw_WxZ24NxB";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadPosts() {
      const { data, error } = await supabase
        .from("wiki_posts")
        .select("*")
        .order("time", { ascending: false });

      const list = document.getElementById("postList");
      list.innerHTML = "";

      if (error) {
        list.textContent = "ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        console.error("ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error.message);
        return;
      }

      if (!data || data.length === 0) {
        list.textContent = "ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      data.forEach(post => {
        const plainText = post.content?.replace(/<[^>]+>/g, "") ?? "";
        const shortText = plainText.length > 100 ? plainText.substring(0, 100) + "..." : plainText;

        let imgHtml = "";
        if (post.images && Array.isArray(post.images)) {
          imgHtml = post.images.map(url => `<img src="${url}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">`).join("");
        }

        const div = document.createElement("div");
        div.className = "post-card";
        div.innerHTML = `
          <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
          <p>${shortText}</p>
          ${imgHtml}
          <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
        `;
        list.appendChild(div);
      });
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById("searchBtn").addEventListener("click", async () => {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      if (!keyword) return;

      const { data, error } = await supabase.from("wiki_posts").select("*");

      if (error) {
        resultsDiv.textContent = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        console.error("ê²€ìƒ‰ ì‹¤íŒ¨:", error.message);
        return;
      }

      const matched = data.filter(post => {
        const title = post.title?.toLowerCase() ?? "";
        const content = post.content?.toLowerCase() ?? "";
        return title.includes(keyword) || content.includes(keyword);
      });

      if (matched.length === 0) {
        resultsDiv.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      matched.forEach(post => {
        const plainText = post.content?.replace(/<[^>]+>/g, "") ?? "";
        const shortText = plainText.length > 100 ? plainText.substring(0, 100) + "..." : plainText;

        const div = document.createElement("div");
        div.className = "post-card";
        div.innerHTML = `
          <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
          <p>${shortText}</p>
          <small>ì‘ì„±ì: ${post.author ?? "ìµëª…"} | ${new Date(post.time).toLocaleString()}</small>
        `;
        resultsDiv.appendChild(div);
      });
    });

    // ê¸€ì“°ê¸° ë²„íŠ¼
    document.getElementById("writeBtn").addEventListener("click", () => {
      location.href = "posts.html";
    });

    // ê´€ë¦¬ì í˜ì´ì§€ ë²„íŠ¼
    document.getElementById("adminBtn").addEventListener("click", () => {
      location.href = "admin.html";
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadPosts();
  </script>

  <!-- ë°©ë¬¸ ê¸°ë¡ ì €ì¥ ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module" src="./js/index.js"></script>
</body>
</html>
